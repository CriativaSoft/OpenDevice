var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={DIGITAL:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,PWM:6,INFRA_RED:7,DEVICE_COMMAND_RESPONSE:10,PING:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,USER_COMMAND:99,isDeviceCommand:function(g){switch(g){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.Event={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_CHANGED:"DEVICE_CHANGED",CONNECTION_CHANGE:"CONNECTION_CHANGE",CONNECTED:"CONNECTION_CHANGE_CONNECTED",DISCONNECTED:"CONNECTION_CHANGE_DISCONNECTED"};od=od||{};
od.Device=function(g){this.id=g.id;this.name=g.name;this.type=g.type;this.category=g.category;this.value=g.value;this.sensor=g.sensor;this.manager=od.deviceManager;this.setValue=function(a){this.value=a;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)}};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(g){function a(a){for(var e=0;e<d.length;e++){var h=d[e].connectionStateChanged;"function"===typeof h&&h(f,a,f.status)}f.status=a}var f=this,b=od.ConnectionStatus,l=window.atmosphere||$.atmosphere,k,d=[];od.connection=this;this.status=b.DISCONNECTED;this.config=g;(function(c){void 0==c.contentType&&(c.contentType="application/json");void 0==c.transport&&(c.transport="websocket");void 0==c.fallbackTransport&&(c.fallbackTransport="long-polling");void 0==c.reconnectInterval&&
(c.reconnectInterval=5E3);void 0==c.maxReconnectOnClose&&(c.maxReconnectOnClose=5);c.onError=function(e){console.log("Connection.onError");a(b.FAIL)};c.onMessage=function(e){var h=null;try{h=JSON.parse(e.responseBody)}catch(a){console.warn("Can't parse response: "+e.responseBody,a.stack)}if(h)for(console.log("Connection.onMessageReceived(from:"+e.request.uuid+") -\x3e "+e.responseBody),e=h,h=0;h<d.length;h++){var b=d[h].onMessageReceived;"function"===typeof b&&b(f,e)}};c.onMessagePublished=function(e){console.log("Connection.onMessagePublished")};
c.onClose=function(e){console.log("Connection.onClose");a(b.DISCONNECTED)};c.onOpen=function(e){console.log("Connection.onOpen");a(b.CONNECTED)};c.onReopen=function(e){console.log("Connection.onReopen");a(b.CONNECTED)};c.onReconnect=function(e){console.log("Connection.onReconnect");a(b.CONNECTING)};c.onTransportFailure=function(e){console.log("Connection.onTransportFailure");a(b.FAIL)};c.onFailureToReconnect=function(e){console.log("Connection.onFailureToReconnect");a(b.DISCONNECTED)};c.onClientTimeout=
function(e){console.log("Connection.onClientTimeout");a(b.FAIL)}})(g);this.connect=function(){f.config.url=f.getUrl();console.log("Connection to: "+f.config.url);k=l.subscribe(f.config);a(b.CONNECTING);return f};this.getUrl=function(){return od.serverURL+"/device/connection/"+od.appID};this.send=function(a){k.push(JSON.stringify(a))};this.addListener=function(a){d.push(a)};this.isConnected=function(){return f.status=b.CONNECTED};this.getConnectionUUID=function(){return k.getUUID()}};od=od||{};
od.deviceManager={};
od.DeviceManager=function(g){function a(e,h){if(void 0!==c[e])for(var a=c[e],b=0;b<a.length;b++)if("function"===typeof a[b])try{a[b](h)}catch(f){console.log(f)}}function f(){for(var e=OpenDevice.devices.list(),a=[],b=0;b<e.length;b++)a.push(new od.Device(e[b]));return a}var b=this;od.deviceManager=this;var l=od.Event,k=od.CommandType,d=[],c={};this.connection=g||od.connection;this.setValue=function(e,h){b.connection.send({type:k.DIGITAL,deviceID:e,value:h});var f=b.findDevice(e);f&&(f.value=h,a(l.DEVICE_CHANGED,
f))};this.toggleValue=function(a){(a=b.findDevice(a))&&!a.sensor&&a.toggleValue()};this.send=function(a){b.connection.send(a)};this.addDevice=function(){};this.getDevices=function(){return d&&0<d.length?d:d=this.sync(!1)};this.findDevice=function(a){if(d)for(var b=0;b<d.length;b++){if(d[b].id==a)return d[b]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(e,h){d=null;d=f();(h||d&&0==d.length)&&b.send({type:k.GET_DEVICES,forceSync:h});!0===e&&a(l.DEVICE_LIST_UPDATE,
d);return d};this.on=function(a,f){b.addListener(a,f)};this.onDeviceChange=function(a){b.addListener(od.Event.DEVICE_CHANGED,a)};this.addListener=function(a,b){void 0===c[a]&&(c[a]=[]);c[a].push(b)};this.contains=function(a,f){null==f&&(f=b.getDevices());for(var c=0;c<f.length;c++)if("object"==typeof f[c]){if(a.id==f[c].id)return!0}else if(a.id==f[c])return!0;return!1};b.connection.addListener({onMessageReceived:function(e,c){if(!k.isDeviceCommand(c.type)||e.getConnectionUUID()!=c.connectionUUID){if(k.isDeviceCommand(c.type)){console.log("Device changed in another client..");
var d=b.findDevice(c.deviceID);d&&(d.value=c.value);d&&a(l.DEVICE_CHANGED,d)}c.type==k.GET_DEVICES_RESPONSE&&(d=f(),a(l.DEVICE_LIST_UPDATE,d))}},connectionStateChanged:function(f,c,d){console.log("DeviceManager._connectionStateChanged :"+c);a(l.CONNECTION_CHANGE,c);od.ConnectionStatus.CONNECTED==c&&a(l.CONNECTED,b.getDevices());od.ConnectionStatus.CONNECTED==c&&a(l.DISCONNECTED)}})};od=od||{};od.APP_ID_NAME="AppID";od.version="1.0";od.appID="*";od.serverURL="http://"+window.location.host;
var OpenDevice=function(){var g=new od.DeviceConnection({logLevel:"debug"}),a=new od.DeviceManager(g);return{appID:od.appID,serverURL:od.serverURL,manager:a,on:a.on,onDeviceChange:a.onDeviceChange,findDevice:a.findDevice,getDevices:a.getDevices,setValue:a.setValue,toggleValue:a.toggleValue,contains:a.contains,sync:a.sync,send:a.send,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){OpenDevice.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();a&&
a(b)});g.connect()},rest:function(a){a=$.ajax({type:"GET",url:od.serverURL+a,headers:{"X-AppID":od.appID},async:!1}).responseText;return 0<a.length?JSON.parse(a):null},history:function(a,b){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json","X-AppID":od.appID},type:"POST",url:od.serverURL+"/device/"+a.deviceID+"/history",data:JSON.stringify(a),dataType:"json",async:!0,success:b})},findAppID:function(){od.appID=function(a){var b;b=window.location.search.substr(1).split("\x26");
if(""==b)b={};else{for(var g={},k=0;k<b.length;++k){var d=b[k].split("\x3d",2);g[d[0]]=1==d.length?"":decodeURIComponent(d[1].replace(/\+/g," "))}b=g}return b[a]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}();
OpenDevice.devices={path:"/device",get:function(g){return OpenDevice.rest(OpenDevice.devices.path+"/"+g)},value:function(g,a){return null!=a?OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value/"+a):OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value")},list:function(){return OpenDevice.rest(OpenDevice.devices.path+"/list")},sync:function(){return OpenDevice.rest(OpenDevice.devices.path+"/sync")}};