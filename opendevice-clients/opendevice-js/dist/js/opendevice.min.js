var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={DIGITAL:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,PWM:6,INFRA_RED:7,DEVICE_COMMAND_RESPONSE:10,PING:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,USER_COMMAND:99,isDeviceCommand:function(f){switch(f){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.Event={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_CHANGED:"DEVICE_CHANGED",CONNECTION_CHANGE:"CONNECTION_CHANGE",CONNECTED:"CONNECTION_CHANGE_CONNECTED",DISCONNECTED:"CONNECTION_CHANGE_DISCONNECTED"};od=od||{};
od.Device=function(f){this.id=f.id;this.name=f.name;this.type=f.type;this.category=f.category;this.value=f.value;this.sensor=f.sensor;this.manager=od.deviceManager;this.setValue=function(a){this.value=a;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)}};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(f){function a(c){for(var d=0;d<g.length;d++){var b=g[d].connectionStateChanged;"function"===typeof b&&b(h,c,h.status)}h.status=c}var h=this,e=od.ConnectionStatus,l=window.atmosphere||$.atmosphere,k,g=[];od.connection=this;this.status=e.DISCONNECTED;this.config=f;(function(c){void 0==c.contentType&&(c.contentType="application/json");void 0==c.transport&&(c.transport="websocket");void 0==c.fallbackTransport&&(c.fallbackTransport="long-polling");void 0==c.reconnectInterval&&
(c.reconnectInterval=5E3);void 0==c.maxReconnectOnClose&&(c.maxReconnectOnClose=5);c.onError=function(d){console.log("Connection.onError");a(e.FAIL)};c.onMessage=function(d){var b=null;try{b=JSON.parse(d.responseBody)}catch(c){console.error("Can't parse response. Error: "+c)}if(b)for(console.log("Connection.onMessageReceived(from:"+d.request.uuid+") -\x3e "+d.responseBody),d=b,b=0;b<g.length;b++){var a=g[b].onMessageReceived;"function"===typeof a&&a(h,d)}};c.onMessagePublished=function(d){console.log("Connection.onMessagePublished")};
c.onClose=function(d){console.log("Connection.onClose");a(e.DISCONNECTED)};c.onOpen=function(d){console.log("Connection.onOpen");a(e.CONNECTED)};c.onReopen=function(d){console.log("Connection.onReopen");a(e.CONNECTED)};c.onReconnect=function(d){console.log("Connection.onReconnect");a(e.CONNECTING)};c.onTransportFailure=function(d){console.log("Connection.onTransportFailure");a(e.FAIL)};c.onFailureToReconnect=function(d){console.log("Connection.onFailureToReconnect");a(e.DISCONNECTED)};c.onClientTimeout=
function(d){console.log("Connection.onClientTimeout");a(e.FAIL)}})(f);this.connect=function(){h.config.url=h.getUrl();console.log("Connection to: "+h.config.url);k=l.subscribe(h.config);a(e.CONNECTING);return h};this.getUrl=function(){return od.serverURL+"/device/connection/"+od.appID};this.send=function(c){k.push(JSON.stringify(c))};this.addListener=function(c){g.push(c)};this.isConnected=function(){return h.status=e.CONNECTED};this.getConnectionUUID=function(){return k.getUUID()}};od=od||{};
od.deviceManager={};
od.DeviceManager=function(f){function a(d){g=null;for(var b=OpenDevice.devices.list(),c=[],a=0;a<b.length;a++)c.push(new od.Device(b[a]));g=c;!0===d&&h(l.DEVICE_LIST_UPDATE,g);return g}function h(d,b){if(void 0!==c[d])for(var a=c[d],h=0;h<a.length;h++)if("function"===typeof a[h])try{a[h](b)}catch(e){console.log(e)}}var e=this;od.deviceManager=this;var l=od.Event,k=od.CommandType,g=[],c={};this.connection=f||od.connection;this.setValue=function(d,b){e.connection.send({type:k.DIGITAL,deviceID:d,value:b});
var a=e.findDevice(d);a&&(a.value=b,h(l.DEVICE_CHANGED,a))};this.toggleValue=function(d){(d=e.findDevice(d))&&!d.sensor&&d.toggleValue()};this.addDevice=function(){};this.getDevices=function(){return g&&0<g.length?g:g=a(!1)};this.findDevice=function(d){if(g)for(var b=0;b<g.length;b++){if(g[b].id==d)return g[b]}else console.warn("Devices not loaded or empty !");return null};this.on=function(d,b){e.addListener(d,b)};this.addListener=function(d,b){void 0===c[d]&&(c[d]=[]);c[d].push(b)};this.contains=
function(d,b){null==b&&(b=e.getDevices());for(var a=0;a<b.length;a++)if("object"==typeof b[a]){if(d.id==b[a].id)return!0}else if(d.id==b[a])return!0;return!1};e.connection.addListener({onMessageReceived:function(a,b){if((!k.isDeviceCommand(b.type)||a.getConnectionUUID()!=b.connectionUUID)&&k.isDeviceCommand(b.type)){console.log("Device changed in another client..");var c=e.findDevice(b.deviceID);c&&(c.value=b.value);c&&h(l.DEVICE_CHANGED,c)}},connectionStateChanged:function(c,b,e){console.log("DeviceManager._connectionStateChanged :"+
b);h(l.CONNECTION_CHANGE,b);od.ConnectionStatus.CONNECTED==b&&(a(!0),h(l.CONNECTED));od.ConnectionStatus.CONNECTED==b&&h(l.DISCONNECTED)}})};od=od||{};od.APP_ID_NAME="AppID";od.version="1.0";od.appID="*";od.serverURL="http://"+window.location.host;
var OpenDevice=function(){var f=new od.DeviceConnection({logLevel:"debug"}),a=new od.DeviceManager(f);return{appID:od.appID,serverURL:od.serverURL,manager:a,on:a.on,findDevice:a.findDevice,getDevices:a.getDevices,setValue:a.setValue,toggleValue:a.toggleValue,contains:a.contains,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(){f.connect()},rest:function(a){a=$.ajax({type:"GET",url:od.serverURL+a,headers:{"X-AppID":od.appID},async:!1}).responseText;return JSON.parse(a)},
findAppID:function(){od.appID=function(a){var e;e=window.location.search.substr(1).split("\x26");if(""==e)e={};else{for(var f={},k=0;k<e.length;++k){var g=e[k].split("\x3d",2);f[g[0]]=1==g.length?"":decodeURIComponent(g[1].replace(/\+/g," "))}e=f}return e[a]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=
window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}();OpenDevice.devices={path:"/device",get:function(f){return OpenDevice.rest(OpenDevice.devices.path+"/"+f)},value:function(f,a){return null!=a?OpenDevice.rest(OpenDevice.devices.path+"/"+f+"/value/"+a):OpenDevice.rest(OpenDevice.devices.path+"/"+f+"/value")},list:function(f){return OpenDevice.rest(OpenDevice.devices.path+"/list")}};