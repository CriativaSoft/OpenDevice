var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={DIGITAL:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,PWM:6,INFRA_RED:7,DEVICE_COMMAND_RESPONSE:10,PING:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,USER_COMMAND:99,isDeviceCommand:function(g){switch(g){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.Event={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_CHANGED:"DEVICE_CHANGED",CONNECTION_CHANGE:"CONNECTION_CHANGE",CONNECTED:"CONNECTION_CHANGE_CONNECTED",DISCONNECTED:"CONNECTION_CHANGE_DISCONNECTED"};od=od||{};
od.Device=function(g){this.id=g.id;this.name=g.name;this.type=g.type;this.category=g.category;this.value=g.value;this.sensor=g.sensor;this.manager=od.deviceManager;this.setValue=function(a){this.value=a;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)}};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(g){function a(b){for(var e=0;e<f.length;e++){var h=f[e].connectionStateChanged;"function"===typeof h&&h(d,b,d.status)}d.status=b}var d=this,c=od.ConnectionStatus,l=window.atmosphere||$.atmosphere,k,f=[];od.connection=this;this.status=c.DISCONNECTED;this.config=g;(function(b){void 0==b.contentType&&(b.contentType="application/json");void 0==b.transport&&(b.transport="websocket");void 0==b.fallbackTransport&&(b.fallbackTransport="long-polling");void 0==b.reconnectInterval&&
(b.reconnectInterval=5E3);void 0==b.maxReconnectOnClose&&(b.maxReconnectOnClose=5);b.onError=function(e){console.log("Connection.onError");a(c.FAIL)};b.onMessage=function(e){var h=null;try{h=JSON.parse(e.responseBody)}catch(b){console.error("Can't parse response. Error: "+b)}if(h)for(console.log("Connection.onMessageReceived(from:"+e.request.uuid+") -\x3e "+e.responseBody),e=h,h=0;h<f.length;h++){var a=f[h].onMessageReceived;"function"===typeof a&&a(d,e)}};b.onMessagePublished=function(e){console.log("Connection.onMessagePublished")};
b.onClose=function(e){console.log("Connection.onClose");a(c.DISCONNECTED)};b.onOpen=function(e){console.log("Connection.onOpen");a(c.CONNECTED)};b.onReopen=function(e){console.log("Connection.onReopen");a(c.CONNECTED)};b.onReconnect=function(e){console.log("Connection.onReconnect");a(c.CONNECTING)};b.onTransportFailure=function(e){console.log("Connection.onTransportFailure");a(c.FAIL)};b.onFailureToReconnect=function(e){console.log("Connection.onFailureToReconnect");a(c.DISCONNECTED)};b.onClientTimeout=
function(e){console.log("Connection.onClientTimeout");a(c.FAIL)}})(g);this.connect=function(){d.config.url=d.getUrl();console.log("Connection to: "+d.config.url);k=l.subscribe(d.config);a(c.CONNECTING);return d};this.getUrl=function(){return od.serverURL+"/device/connection/"+od.appID};this.send=function(d){k.push(JSON.stringify(d))};this.addListener=function(d){f.push(d)};this.isConnected=function(){return d.status=c.CONNECTED};this.getConnectionUUID=function(){return k.getUUID()}};od=od||{};
od.deviceManager={};
od.DeviceManager=function(g){function a(e){f=null;for(var h=OpenDevice.devices.list(),a=[],b=0;b<h.length;b++)a.push(new od.Device(h[b]));f=a;!0===e&&d(l.DEVICE_LIST_UPDATE,f);return f}function d(e,h){if(void 0!==b[e])for(var d=b[e],a=0;a<d.length;a++)if("function"===typeof d[a])try{d[a](h)}catch(c){console.log(c)}}var c=this;od.deviceManager=this;var l=od.Event,k=od.CommandType,f=[],b={};this.connection=g||od.connection;this.setValue=function(e,h){c.connection.send({type:k.DIGITAL,deviceID:e,value:h});
var a=c.findDevice(e);a&&(a.value=h,d(l.DEVICE_CHANGED,a))};this.toggleValue=function(e){(e=c.findDevice(e))&&!e.sensor&&e.toggleValue()};this.addDevice=function(){};this.getDevices=function(){return f&&0<f.length?f:f=a(!1)};this.findDevice=function(e){if(f)for(var a=0;a<f.length;a++){if(f[a].id==e)return f[a]}else console.warn("Devices not loaded or empty !");return null};this.on=function(a,d){c.addListener(a,d)};this.onDeviceChange=function(a){c.addListener(od.Event.DEVICE_CHANGED,a)};this.addListener=
function(a,d){void 0===b[a]&&(b[a]=[]);b[a].push(d)};this.contains=function(a,d){null==d&&(d=c.getDevices());for(var b=0;b<d.length;b++)if("object"==typeof d[b]){if(a.id==d[b].id)return!0}else if(a.id==d[b])return!0;return!1};c.connection.addListener({onMessageReceived:function(a,b){if((!k.isDeviceCommand(b.type)||a.getConnectionUUID()!=b.connectionUUID)&&k.isDeviceCommand(b.type)){console.log("Device changed in another client..");var f=c.findDevice(b.deviceID);f&&(f.value=b.value);f&&d(l.DEVICE_CHANGED,
f)}},connectionStateChanged:function(b,c,f){console.log("DeviceManager._connectionStateChanged :"+c);d(l.CONNECTION_CHANGE,c);od.ConnectionStatus.CONNECTED==c&&(a(!0),d(l.CONNECTED));od.ConnectionStatus.CONNECTED==c&&d(l.DISCONNECTED)}})};od=od||{};od.APP_ID_NAME="AppID";od.version="1.0";od.appID="*";od.serverURL="http://"+window.location.host;
var OpenDevice=function(){var g=new od.DeviceConnection({logLevel:"debug"}),a=new od.DeviceManager(g);return{appID:od.appID,serverURL:od.serverURL,manager:a,on:a.on,onDeviceChange:a.onDeviceChange,findDevice:a.findDevice,getDevices:a.getDevices,setValue:a.setValue,toggleValue:a.toggleValue,contains:a.contains,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){OpenDevice.on(od.Event.CONNECTED,function(){var c=OpenDevice.getDevices();a&&a(c)});g.connect()},rest:function(a){a=
$.ajax({type:"GET",url:od.serverURL+a,headers:{"X-AppID":od.appID},async:!1}).responseText;return JSON.parse(a)},findAppID:function(){od.appID=function(a){var c;c=window.location.search.substr(1).split("\x26");if(""==c)c={};else{for(var g={},k=0;k<c.length;++k){var f=c[k].split("\x3d",2);g[f[0]]=1==f.length?"":decodeURIComponent(f[1].replace(/\+/g," "))}c=g}return c[a]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.APP_ID_NAME);
if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}();OpenDevice.devices={path:"/device",get:function(g){return OpenDevice.rest(OpenDevice.devices.path+"/"+g)},value:function(g,a){return null!=a?OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value/"+a):OpenDevice.rest(OpenDevice.devices.path+"/"+g+"/value")},list:function(g){return OpenDevice.rest(OpenDevice.devices.path+"/list")}};