var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2,ANALOG_SIGNED:3,NUMERIC:4,FLOAT2:5,FLOAT2_SIGNED:6,FLOAT4:7,CHARACTER:8,BOARD:10,MANAGER:11,isNumeric:function(d){return d==od.DeviceType.ANALOG||d==od.DeviceType.FLOAT2||d==od.DeviceType.FLOAT4||d==od.DeviceType.FLOAT2_SIGNED}};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};
od.CommandType={DIGITAL:1,ANALOG:2,NUMERIC:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,INFRA_RED:6,DEVICE_COMMAND_RESPONSE:10,COMMAND_RESPONSE:11,SET_PROPERTY:12,ACTION:13,PING_REQUEST:20,PING_RESPONSE:21,DISCOVERY_REQUEST:22,DISCOVERY_RESPONSE:23,MEMORY_REPORT:24,CPU_TEMPERATURE_REPORT:25,CPU_USAGE_REPORT:26,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,DEVICE_SAVE:32,DEVICE_SAVE_RESPONSE:33,DEVICE_DEL:34,CLEAR_DEVICES:35,SYNC_DEVICES_ID:36,SYNC_HISTORY:37,FIRMWARE_UPDATE:38,GET_CONNECTIONS:40,GET_CONNECTIONS_RESPONSE:41,
CONNECTION_ADD:42,CONNECTION_ADD_RESPONSE:43,CONNECTION_DEL:44,CLEAR_CONNECTIONS:45,CONNECT:46,CONNECT_RESPONSE:47,USER_EVENT:98,USER_COMMAND:99,isDeviceCommand:function(d){switch(d){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.NUMERIC:return!0}return!1}};od.CommandStatus={DELIVERED:1,RECEIVED:2,FAIL:3,EMPTY_DATABASE:4,SUCCESS:200,NOT_FOUND:404,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,PERMISSION_DENIED:550,INTERNAL_ERROR:500,NOT_IMPLEMENTED:501};
od.Event={DEVICE_LIST_UPDATE:"devicesUpdate",DEVICE_CHANGED:"deviceChanged",CONNECTION_CHANGE:"connectionCgange",CONNECTED:"connected",DISCONNECTED:"disconnected",LOGIN_FAILURE:"loginFail"};od=od||{};
od.Device=function(d){var b=od.CommandType,e=this;this.type=od.DeviceType.DIGITAL;this.listeners=[];this.on=function(){this.setValue(1,!0)};this.off=function(){this.setValue(0,!0)};this.isON=function(){return 1==this.value};this.isOFF=function(){return 0==this.value};this.setValue=function(a,c){c="undefined"!==typeof c?c:!0;this.type==od.DeviceType.FLOAT2?a/=100:this.type==od.DeviceType.FLOAT4?a/=1E4:this.type==od.DeviceType.FLOAT2_SIGNED?alert("FLOAT2_SIGNED - conversion not implemented"):this.type==
od.DeviceType.ANALOG_SIGNED&&alert("ANALOG_SIGNED - conversion not implemented");if(this.type==od.DeviceType.NUMERIC||this.value!=a)this.value=a,this.lastUpdate=(new Date).getTime(),this.manager&&this.manager.notifyDeviceListeners(this,c)};this.toggleValue=this.toggle=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)};this.onChange=function(a,c){var b={context:c,listener:a};this.listeners.push(b);return b};this.removeListener=function(b){b=this.listeners.indexOf(b);0<=b&&
this.listeners.splice(b,1)};this.applyChanges=function(b){for(var c in b)b.hasOwnProperty(c)&&"function"!=typeof b[c]&&(this[c]=b[c])};(function(a){this.id=a.id;this.manager=od.deviceManager;for(var c in a)this[c]=a[c];for(var d in this.properties)this[d]=this.properties[d];this.description||(this.description=this.name);this.actions.forEach(function(c){e[c]=function(){console.log("Calling remote action: "+c+", params: ",arguments);var a=[],n;for(n in arguments)a.push(arguments[n]);e.manager.send({type:b.ACTION,
deviceID:e.id,action:c,params:a})}})}).call(this,d)};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(d){function b(c){for(var b=0;b<l.length;b++){var e=l[b].onMessageReceived;"function"===typeof e&&e(a,c)}}function e(b){a.status=b;for(var c=0;c<l.length;c++){var e=l[c].connectionStateChanged;"function"===typeof e&&e(a,b,a.status)}}var a=this,c=od.ConnectionStatus,k=window.atmosphere||$.atmosphere,f,l=[];od.connection=this;this.status=c.DISCONNECTED;this.config=d;(function(a){void 0==a.contentType&&(a.contentType="application/json");void 0==a.transport&&(a.transport="websocket");
void 0==a.fallbackTransport&&(a.fallbackTransport="long-polling");void 0==a.reconnectInterval&&(a.reconnectInterval=5E3);void 0==a.maxReconnectOnClose&&(a.maxReconnectOnClose=5);a.enableProtocol=!1;a.onError=function(b){console.log("Connection.onError");e(c.FAIL)};a.onMessage=function(c){a:{var a=null;if("X"!=c.responseBody){try{a=JSON.parse(c.responseBody)}catch(e){console.error("Can't parse response: \x3c\x3c"+c.responseBody+"\x3e\x3e");console.error(e.stack);break a}!a.status||401!=a.status&&403!=
a.status?a&&(console.log("Connection.onMessageReceived(from:"+c.request.uuid+") -\x3e "+c.responseBody),b(a)):(console.warn("Authorization Required"),b({type:od.CommandType.CONNECT_RESPONSE,status:od.CommandStatus.UNAUTHORIZED}))}}};a.onMessagePublished=function(c){console.log("Connection.onMessagePublished")};a.onClose=function(a){console.log("Connection.onClose");e(c.DISCONNECTED)};a.onOpen=function(a){console.log("Connection.onOpen");e(c.CONNECTED)};a.onReopen=function(a){console.log("Connection.onReopen");
e(c.CONNECTED)};a.onReconnect=function(a){console.log("Connection.onReconnect");e(c.CONNECTING)};a.onTransportFailure=function(a){console.log("Connection.onTransportFailure");e(c.FAIL)};a.onFailureToReconnect=function(a){console.log("Connection.onFailureToReconnect");e(c.DISCONNECTED)};a.onClientTimeout=function(a){console.log("Connection.onClientTimeout");e(c.FAIL)}})(d);this.connect=function(){a.status!=c.CONNECTED?(a.config.url=a.getUrl(),console.log("Connection to: "+a.config.url),f=k.subscribe(a.config),
e(c.CONNECTING)):console.log("Already Connected");return a};this.getUrl=function(){return od.serverURL+"/ws/device/"+od.appID};this.send=function(a){f.push(JSON.stringify(a))};this.addListener=function(a){l.push(a)};this.isConnected=function(){return a.status==c.CONNECTED};this.getConnectionUUID=function(){return f.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(d){function b(h,a){if(void 0!==m[h])for(var c=m[h],b=0;b<c.length;b++)if("function"===typeof c[b])try{c[b](a)}catch(e){console.log(e)}}function e(){var h=OpenDevice.devices.list(),c=[];0<h.length&&q.updateDevices(h);for(var b=0;b<h.length;b++){var e=new od.Device(h[b]);"undefined"!=typeof Object.observe?Object.observe(e,a):console.warn("Object.observe not supported in this browser.");c.push(e)}return c}function a(h){if(0<h.length&&"update"==h[0].type&&"value"!=h[0].name){var a=
h[0].object;c.send({type:f.SET_PROPERTY,deviceID:a.id,property:h[0].name,value:a[h[0].name]})}}var c=this;od.deviceManager=this;var k=od.Event,f=od.CommandType,l=od.DeviceType,n=[],q=new od.DeviceStorage,m={},p=[];this.connection=d||od.connection;this.setValue=function(a,b){var g=c.findDevice(a);g&&g.setValue(b)};this.toggleValue=function(a){(a=c.findDevice(a))&&!a.sensor&&a.toggle()};this.send=function(a){c.connection.send(a)};this.addDevice=function(){};this.removeDevice=function(a){return ODev.devices["delete"](a.id,
function(){var c=devices.indexOf(a);0<=c&&devices.splice(c,1);b(k.DEVICE_LIST_UPDATE,devices)})};this.deleteHitory=function(a){return ODev.devices.deleteHistory(a.id)};this.getDevices=function(){var a=q.getDevices();return a&&0<a.length?a:a=this.sync(!1)};this.getDevicesByType=function(a,c){c||(c=this.getDevices());var b=[];c&&c.forEach(function(c){c.type==a&&b.push(c)});return b};this.getDevicesByBoard=function(a){var c=this.getDevices(),b=[];c&&c.forEach(function(c){c.parentID==a&&c.type!=l.BOARD&&
b.push(c)});return b};this.getBoards=function(){return this.getDevicesByType(l.BOARD)};this.getTypes=function(){0==n.length&&ODev.devices.listTypes(function(a){0<a.length&&a.forEach(function(a){n.push(a)})});return n};this.findDevice=function(a,c){c||(c=this.getDevices());if(c)for(var b=0;b<c.length;b++){if(c[b].id==a)return c[b]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(a,r){var g=e();(r||g&&0==g.length)&&c.send({type:f.GET_DEVICES,forceSync:r});g&&g.forEach(function(a){a.parentID&&
(a.parent=c.findDevice(a.parentID,g))});!0===a&&b(k.DEVICE_LIST_UPDATE,g);return g};this.save=function(a,b){ODev.send({type:f.DEVICE_SAVE,device:a});var e=c.findDevice(a.id);null!=e&&(e.applyChanges(a),c.notifyDeviceListeners(e,!1),b&&b.call(e,!0))};this.on=function(a,b){return c.addListener(a,b)};this.onDeviceChange=function(a){c.addListener(od.Event.DEVICE_CHANGED,a)};this.onConnect=function(a){if(c.isConnected()){var b=OpenDevice.getDevices();a&&a(b);return{event:od.Event.CONNECTED}}return this.on(od.Event.CONNECTED,
function(){var c=OpenDevice.getDevices();a&&a(c)})};this.removeListener=function(a,c){var b;if(a instanceof Array){c==p&&(p=null);for(var e=0;e<a.length;e++)this.removeListener(a[e])}else"object"==typeof a?(b=a.event,c=a.listener):b=a;null!=m[b]&&(b=m[b],e=b.indexOf(c),0<=e&&b.splice(e,1))};this.addListener=function(a,c){void 0===m[a]&&(m[a]=[]);m[a].push(c);var b={event:a,listener:c};p&&p.push(b);return b};this.setListenerReceiver=function(a){p=a};this.contains=function(a,b){null==b&&(b=c.getDevices());
for(var e=0;e<b.length;e++)if("object"==typeof b[e]){if(a.id==b[e].id)return!0}else if(a.id==b[e])return!0;return!1};this.isConnected=function(){return c.connection.isConnected()};this.notifyDeviceListeners=function(a,e){e&&c.connection.send({type:a.type,deviceID:a.id,value:a.value});for(var d=0;d<a.listeners.length;d++)if("function"==typeof a.listeners[d])a.listeners[d](a.value,a.id);else a.listeners[d].listener.call(a.listeners[d].context,a.value,a.id);b(k.DEVICE_CHANGED,a)};this.notifyListeners=
function(a,c){b(a,c)};c.connection.addListener({onMessageReceived:function(a,d){if(!f.isDeviceCommand(d.type)||a.getConnectionUUID()!=d.connectionUUID)if(d.type==f.CONNECT_RESPONSE&&d.status==od.CommandStatus.UNAUTHORIZED)b(k.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED);else if(d.type==f.USER_EVENT)b(d.name,d);else{if(f.isDeviceCommand(d.type)){var g=c.findDevice(d.deviceID);g&&g.setValue(d.value,!1)}d.type==f.GET_DEVICES_RESPONSE&&(g=e())&&0<g.length&&b(k.DEVICE_LIST_UPDATE,g)}},connectionStateChanged:function(a,
e,d){console.log("DeviceManager._connectionStateChanged :"+e);b(k.CONNECTION_CHANGE,e);od.ConnectionStatus.CONNECTED==e&&b(k.CONNECTED,c.getDevices());od.ConnectionStatus.DISCONNECTED==e&&b(k.DISCONNECTED)}})};od=od||{};
od.DeviceStorage=function(){var d=[];this.getDevices=function(){return d};this.updateDevices=function(b){localStorage.setItem(od.DEVICES_STORAGE_ID,JSON.stringify(b));for(var e=0;e<b.length;e++){var a=b[e],c;a:{for(c=0;c<d.length;c++){var k=d[c];if(k.id==a.id){c=k;break a}}c=void 0}c?c.updateRawData(a):d.push(new od.Device(a))}}};od=od||{};od.SESSION_ID="AuthToken";od.DEVICES_STORAGE_ID="odev_devices";od.version="0.3.2";od.appID="*";od.serverURL=window.location.origin;
var OpenDevice=function(){var d=new od.DeviceConnection({logLevel:"debug"}),b=new od.DeviceManager(d);return{appID:od.appID,serverURL:od.serverURL,manager:b,on:b.on,removeListener:b.removeListener,notifyListeners:b.notifyListeners,setListenerReceiver:b.setListenerReceiver,onDeviceChange:b.onDeviceChange,onChange:b.onDeviceChange,onConnect:b.onConnect,isConnected:b.isConnected,findDevice:b.findDevice,get:b.findDevice,removeDevice:b.removeDevice,deleteHitory:b.deleteHitory,getDevices:b.getDevices,getDevicesByType:b.getDevicesByType,
getDevicesByBoard:b.getDevicesByBoard,getBoards:b.getBoards,getTypes:b.getTypes,setValue:b.setValue,toggleValue:b.toggleValue,contains:b.contains,sync:b.sync,save:b.save,send:b.send,setAppID:function(b){od.appID=b},setServer:function(b){od.serverURL=b},connect:function(b){b&&(d=b);d.connect()},rest:function(e,a){var c={type:"GET",url:od.serverURL+e,headers:{Authorization:"Bearer "+od.appID},async:!1};$.extend(c,a||{});var d=$.ajax(c);d.fail(function(){console.error("Rest fail, status ("+d.status+
"): "+d.responseText);401==d.status&&b.notifyListeners(od.Event.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED)});return null==c.async||0==c.async?200==d.status&&0<d.responseText.length?JSON.parse(d.responseText):null:d},history:function(b,a,c){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+od.appID},type:"POST",url:od.serverURL+OpenDevice.devices.path+"/"+b.deviceID+"/history",data:JSON.stringify(b),dataType:"json",async:!0,success:a,error:c})},
logout:function(b){return $.get(od.serverURL+"/api/auth/logout",b)},findAppID:function(){od.appID=function(b){var a;a=window.location.search.substr(1).split("\x26");if(""==a)a={};else{for(var c={},d=0;d<a.length;++d){var f=a[d].split("\x3d",2);c[f[0]]=1==f.length?"":decodeURIComponent(f[1].replace(/\+/g," "))}a=c}return a[b]}(od.SESSION_ID);if(null!=od.appID)return od.appID;od.appID=function(b){b=("; "+document.cookie).split("; "+b+"\x3d");if(2==b.length)return b.pop().split(";").shift()}(od.SESSION_ID);
if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.SESSION_ID));return od.appID}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/api/devices",get:function(d){return OpenDevice.rest(this.path+"/"+d)},value:function(d,b){return null!=b?OpenDevice.rest(this.path+"/"+d+"/value/"+b):OpenDevice.rest(this.path+"/"+d+"/value")},list:function(){return OpenDevice.rest(this.path+"/")},listTypes:function(d,b){return OpenDevice.rest(this.path+"/types",{async:!0,success:d,error:b})},sync:function(){return OpenDevice.rest(this.path+"/sync")},"delete":function(d,b,e){return OpenDevice.rest(this.path+"/"+d,{async:!0,
type:"DELETE",success:b,error:e})},deleteHistory:function(d,b,e){return OpenDevice.rest(this.path+"/"+d+"/history",{async:!0,type:"DELETE",success:b,error:e})}};