var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};
od.CommandType={DIGITAL:1,ANALOG:2,NUMERIC:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,INFRA_RED:6,DEVICE_COMMAND_RESPONSE:10,COMMAND_RESPONSE:11,SET_PROPERTY:12,ACTION:13,PING_REQUEST:20,PING_RESPONSE:21,DISCOVERY_REQUEST:22,DISCOVERY_RESPONSE:23,MEMORY_REPORT:24,CPU_TEMPERATURE_REPORT:25,CPU_USAGE_REPORT:26,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,DEVICE_ADD:32,DEVICE_ADD_RESPONSE:33,DEVICE_DEL:34,CLEAR_DEVICES:35,GET_CONNECTIONS:36,GET_CONNECTIONS_RESPONSE:37,CONNECTION_ADD:38,CONNECTION_ADD_RESPONSE:39,CONNECTION_DEL:40,
CLEAR_CONNECTIONS:41,USER_COMMAND:99,isDeviceCommand:function(e){switch(e){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.NUMERIC:return!0}return!1}};od.Event={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_CHANGED:"DEVICE_CHANGED",CONNECTION_CHANGE:"CONNECTION_CHANGE",CONNECTED:"CONNECTION_CHANGE_CONNECTED",DISCONNECTED:"CONNECTION_CHANGE_DISCONNECTED"};od=od||{};
od.Device=function(e){var c=od.CommandType,b=this;this.on=function(){this.setValue(1)};this.off=function(){this.setValue(0)};this.isON=function(){return 1==value};this.isOFF=function(){return 0==value};this.setValue=function(b){this.value=b;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=this.toggle=function(){var b=0;0==this.value?b=1:1==this.value&&(b=0);this.setValue(b)};(function(d){this.id=d.id;this.manager=od.deviceManager;for(var f in d)this[f]=d[f];for(var h in this.properties)this[h]=
this.properties[h];this.actions.forEach(function(d){b[d]=function(){console.log("Calling remote action: "+d+", params: ",arguments);var a=[],l;for(l in arguments)a.push(arguments[l]);b.manager.send({type:c.ACTION,deviceID:b.id,action:d,params:a})}})}).call(this,e)};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(e){function c(a){for(var c=0;c<g.length;c++){var k=g[c].connectionStateChanged;"function"===typeof k&&k(b,a,b.status)}b.status=a}var b=this,d=od.ConnectionStatus,f=window.atmosphere||$.atmosphere,h,g=[];od.connection=this;this.status=d.DISCONNECTED;this.config=e;(function(a){void 0==a.contentType&&(a.contentType="application/json");void 0==a.transport&&(a.transport="websocket");void 0==a.fallbackTransport&&(a.fallbackTransport="long-polling");void 0==a.reconnectInterval&&
(a.reconnectInterval=5E3);void 0==a.maxReconnectOnClose&&(a.maxReconnectOnClose=5);a.onError=function(a){console.log("Connection.onError");c(d.FAIL)};a.onMessage=function(a){var k=null;if("X"!=a.responseBody){try{k=JSON.parse(a.responseBody)}catch(m){console.warn("Can't parse response: "+a.responseBody,m.stack)}if(k)for(console.log("Connection.onMessageReceived(from:"+a.request.uuid+") -\x3e "+a.responseBody),a=k,k=0;k<g.length;k++){var c=g[k].onMessageReceived;"function"===typeof c&&c(b,a)}}};a.onMessagePublished=
function(a){console.log("Connection.onMessagePublished")};a.onClose=function(a){console.log("Connection.onClose");c(d.DISCONNECTED)};a.onOpen=function(a){console.log("Connection.onOpen");c(d.CONNECTED)};a.onReopen=function(a){console.log("Connection.onReopen");c(d.CONNECTED)};a.onReconnect=function(a){console.log("Connection.onReconnect");c(d.CONNECTING)};a.onTransportFailure=function(a){console.log("Connection.onTransportFailure");c(d.FAIL)};a.onFailureToReconnect=function(a){console.log("Connection.onFailureToReconnect");
c(d.DISCONNECTED)};a.onClientTimeout=function(a){console.log("Connection.onClientTimeout");c(d.FAIL)}})(e);this.connect=function(){b.config.url=b.getUrl();console.log("Connection to: "+b.config.url);h=f.subscribe(b.config);c(d.CONNECTING);return b};this.getUrl=function(){return od.serverURL+"/device/connection/"+od.appID};this.send=function(a){h.push(JSON.stringify(a))};this.addListener=function(a){g.push(a)};this.isConnected=function(){return b.status=d.CONNECTED};this.getConnectionUUID=function(){return h.getUUID()}};
od=od||{};od.deviceManager={};
od.DeviceManager=function(e){function c(a,b){if(void 0!==l[a])for(var c=l[a],d=0;d<c.length;d++)if("function"===typeof c[d])try{c[d](b)}catch(f){console.log(f)}}function b(){for(var a=OpenDevice.devices.list(),b=[],c=0;c<a.length;c++){var f=new od.Device(a[c]);"undefined"!=typeof Object.observe?Object.observe(f,d):console.warn("Object.observe not supported in this browser.");b.push(f)}return b}function d(a){if(0<a.length&&"update"==a[0].type&&"value"!=a[0].name){var c=a[0].object;f.send({type:g.SET_PROPERTY,
deviceID:c.id,property:a[0].name,value:c[a[0].name]})}}var f=this;od.deviceManager=this;var h=od.Event,g=od.CommandType,a=[],l={};this.connection=e||od.connection;this.setValue=function(a,b){f.connection.send({type:g.DIGITAL,deviceID:a,value:b});var d=f.findDevice(a);d&&(d.value=b,c(h.DEVICE_CHANGED,d))};this.toggleValue=function(a){(a=f.findDevice(a))&&!a.sensor&&a.toggleValue()};this.send=function(a){f.connection.send(a)};this.addDevice=function(){};this.getDevices=function(){return a&&0<a.length?
a:a=this.sync(!1)};this.findDevice=function(c){if(a)for(var b=0;b<a.length;b++){if(a[b].id==c)return a[b]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(d,m){a=null;a=b();(m||a&&0==a.length)&&f.send({type:g.GET_DEVICES,forceSync:m});!0===d&&c(h.DEVICE_LIST_UPDATE,a);return a};this.on=function(a,b){f.addListener(a,b)};this.onDeviceChange=function(a){f.addListener(od.Event.DEVICE_CHANGED,a)};this.onConnect=function(a){this.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();
a&&a(b)})};this.addListener=function(a,b){void 0===l[a]&&(l[a]=[]);l[a].push(b)};this.contains=function(a,b){null==b&&(b=f.getDevices());for(var c=0;c<b.length;c++)if("object"==typeof b[c]){if(a.id==b[c].id)return!0}else if(a.id==b[c])return!0;return!1};f.connection.addListener({onMessageReceived:function(a,d){if(!g.isDeviceCommand(d.type)||a.getConnectionUUID()!=d.connectionUUID){if(g.isDeviceCommand(d.type)){console.log("Device changed in another client..");var e=f.findDevice(d.deviceID);e&&(e.value=
d.value);e&&c(h.DEVICE_CHANGED,e)}d.type==g.GET_DEVICES_RESPONSE&&(e=b(),c(h.DEVICE_LIST_UPDATE,e))}},connectionStateChanged:function(a,b,d){console.log("DeviceManager._connectionStateChanged :"+b);c(h.CONNECTION_CHANGE,b);od.ConnectionStatus.CONNECTED==b&&c(h.CONNECTED,f.getDevices());od.ConnectionStatus.CONNECTED==b&&c(h.DISCONNECTED)}})};od=od||{};od.APP_ID_NAME="AppID";od.version="1.0";od.appID="*";od.serverURL="http://"+window.location.host;
var OpenDevice=function(){var e=new od.DeviceConnection({logLevel:"debug"}),c=new od.DeviceManager(e);return{appID:od.appID,serverURL:od.serverURL,manager:c,on:c.on,onDeviceChange:c.onDeviceChange,onChange:c.onDeviceChange,onConnect:c.onConnect,findDevice:c.findDevice,getDevices:c.getDevices,setValue:c.setValue,toggleValue:c.toggleValue,contains:c.contains,sync:c.sync,send:c.send,setAppID:function(b){od.appID=b},setServer:function(b){od.serverURL=b},connect:function(b){b&&(e=b);e.connect()},rest:function(b){b=
$.ajax({type:"GET",url:od.serverURL+b,headers:{"X-AppID":od.appID},async:!1}).responseText;return 0<b.length?JSON.parse(b):null},history:function(b,c){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json","X-AppID":od.appID},type:"POST",url:od.serverURL+"/device/"+b.deviceID+"/history",data:JSON.stringify(b),dataType:"json",async:!0,success:c})},findAppID:function(){od.appID=function(b){var c;c=window.location.search.substr(1).split("\x26");if(""==c)c={};else{for(var f=
{},e=0;e<c.length;++e){var g=c[e].split("\x3d",2);f[g[0]]=1==g.length?"":decodeURIComponent(g[1].replace(/\+/g," "))}c=f}return c[b]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(b){b=("; "+document.cookie).split("; "+b+"\x3d");if(2==b.length)return b.pop().split(";").shift()}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/device",get:function(e){return OpenDevice.rest(OpenDevice.devices.path+"/"+e)},value:function(e,c){return null!=c?OpenDevice.rest(OpenDevice.devices.path+"/"+e+"/value/"+c):OpenDevice.rest(OpenDevice.devices.path+"/"+e+"/value")},list:function(){return OpenDevice.rest(OpenDevice.devices.path+"/list")},sync:function(){return OpenDevice.rest(OpenDevice.devices.path+"/sync")}};