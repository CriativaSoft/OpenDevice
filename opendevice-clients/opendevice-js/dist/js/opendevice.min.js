var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2,NUMERIC:3,CHARACTER:4,BOARD:10,MANAGER:11};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};
od.CommandType={DIGITAL:1,ANALOG:2,NUMERIC:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,INFRA_RED:6,DEVICE_COMMAND_RESPONSE:10,COMMAND_RESPONSE:11,SET_PROPERTY:12,ACTION:13,PING_REQUEST:20,PING_RESPONSE:21,DISCOVERY_REQUEST:22,DISCOVERY_RESPONSE:23,MEMORY_REPORT:24,CPU_TEMPERATURE_REPORT:25,CPU_USAGE_REPORT:26,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,DEVICE_SAVE:32,DEVICE_SAVE_RESPONSE:33,DEVICE_DEL:34,CLEAR_DEVICES:35,GET_CONNECTIONS:36,GET_CONNECTIONS_RESPONSE:37,CONNECTION_ADD:38,CONNECTION_ADD_RESPONSE:39,CONNECTION_DEL:40,
CLEAR_CONNECTIONS:41,CONNECT:42,CONNECT_RESPONSE:43,USER_EVENT:98,USER_COMMAND:99,isDeviceCommand:function(e){switch(e){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.NUMERIC:return!0}return!1}};od.CommandStatus={DELIVERED:1,RECEIVED:2,FAIL:3,EMPTY_DATABASE:4,SUCCESS:200,NOT_FOUND:404,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,PERMISSION_DENIED:550,INTERNAL_ERROR:500,NOT_IMPLEMENTED:501};
od.Event={DEVICE_LIST_UPDATE:"devicesUpdate",DEVICE_CHANGED:"deviceChanged",CONNECTION_CHANGE:"connectionCgange",CONNECTED:"connected",DISCONNECTED:"disconnected",LOGIN_FAILURE:"loginFail"};od=od||{};
od.Device=function(e){var a=od.CommandType,d=this;this.type=od.DeviceType.DIGITAL;this.listeners=[];this.on=function(){this.setValue(1,!0)};this.off=function(){this.setValue(0,!0)};this.isON=function(){return 1==this.value};this.isOFF=function(){return 0==this.value};this.setValue=function(a,c){c="undefined"!==typeof c?c:!0;if(this.type==od.DeviceType.NUMERIC||this.value!=a)this.value=a,this.lastUpdate=(new Date).getTime(),this.manager&&this.manager.notifyDeviceListeners(this,c)};this.toggleValue=
this.toggle=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)};this.onChange=function(a,c){var d={context:c,listener:a};this.listeners.push(d);return d};this.removeListener=function(a){a=this.listeners.indexOf(a);0<=a&&this.listeners.splice(a,1)};(function(b){this.id=b.id;this.manager=od.deviceManager;for(var c in b)this[c]=b[c];for(var e in this.properties)this[e]=this.properties[e];this.description||(this.description=this.name);this.actions.forEach(function(c){d[c]=function(){console.log("Calling remote action: "+
c+", params: ",arguments);var b=[],m;for(m in arguments)b.push(arguments[m]);d.manager.send({type:a.ACTION,deviceID:d.id,action:c,params:b})}})}).call(this,e)};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(e){function a(a){for(var c=0;c<h.length;c++){var d=h[c].onMessageReceived;"function"===typeof d&&d(b,a)}}function d(a){for(var c=0;c<h.length;c++){var d=h[c].connectionStateChanged;"function"===typeof d&&d(b,a,b.status)}b.status=a}var b=this,c=od.ConnectionStatus,k=window.atmosphere||$.atmosphere,f,h=[];od.connection=this;this.status=c.DISCONNECTED;this.config=e;(function(b){void 0==b.contentType&&(b.contentType="application/json");void 0==b.transport&&(b.transport="websocket");
void 0==b.fallbackTransport&&(b.fallbackTransport="long-polling");void 0==b.reconnectInterval&&(b.reconnectInterval=5E3);void 0==b.maxReconnectOnClose&&(b.maxReconnectOnClose=5);b.enableProtocol=!1;b.onError=function(a){console.log("Connection.onError");d(c.FAIL)};b.onMessage=function(c){a:{var b=null;if("X"!=c.responseBody){try{b=JSON.parse(c.responseBody)}catch(d){console.error("Can't parse response: \x3c\x3c"+c.responseBody+"\x3e\x3e");console.error(d.stack);break a}!b.status||401!=b.status&&403!=
b.status?b&&(console.log("Connection.onMessageReceived(from:"+c.request.uuid+") -\x3e "+c.responseBody),a(b)):(console.warn("Authorization Required"),a({type:od.CommandType.CONNECT_RESPONSE,status:od.CommandStatus.UNAUTHORIZED}))}}};b.onMessagePublished=function(c){console.log("Connection.onMessagePublished")};b.onClose=function(a){console.log("Connection.onClose");d(c.DISCONNECTED)};b.onOpen=function(a){console.log("Connection.onOpen");d(c.CONNECTED)};b.onReopen=function(a){console.log("Connection.onReopen");
d(c.CONNECTED)};b.onReconnect=function(a){console.log("Connection.onReconnect");d(c.CONNECTING)};b.onTransportFailure=function(a){console.log("Connection.onTransportFailure");d(c.FAIL)};b.onFailureToReconnect=function(a){console.log("Connection.onFailureToReconnect");d(c.DISCONNECTED)};b.onClientTimeout=function(a){console.log("Connection.onClientTimeout");d(c.FAIL)}})(e);this.connect=function(){b.status!=c.CONNECTED?(b.config.url=b.getUrl(),console.log("Connection to: "+b.config.url),f=k.subscribe(b.config),
d(c.CONNECTING)):console.log("Already Connected");return b};this.getUrl=function(){return od.serverURL+"/ws/device/"+od.appID};this.send=function(a){f.push(JSON.stringify(a))};this.addListener=function(a){h.push(a)};this.isConnected=function(){return b.status=c.CONNECTED};this.getConnectionUUID=function(){return f.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(e){function a(n,a){if(void 0!==l[n])for(var c=l[n],b=0;b<c.length;b++)if("function"===typeof c[b])try{c[b](a)}catch(d){console.log(d)}}function d(){for(var n=OpenDevice.devices.list(),a=[],c=0;c<n.length;c++){var d=new od.Device(n[c]);"undefined"!=typeof Object.observe?Object.observe(d,b):console.warn("Object.observe not supported in this browser.");a.push(d)}k=!0;return a}function b(a){if(0<a.length&&"update"==a[0].type&&"value"!=a[0].name){var b=a[0].object;c.send({type:h.SET_PROPERTY,
deviceID:b.id,property:a[0].name,value:b[a[0].name]})}}var c=this,k=!1;od.deviceManager=this;var f=od.Event,h=od.CommandType,m=od.DeviceType,g=[],q=[],l={},p=[];this.connection=e||od.connection;this.setValue=function(a,b){var d=c.findDevice(a);d&&d.setValue(b)};this.toggleValue=function(a){(a=c.findDevice(a))&&!a.sensor&&a.toggle()};this.send=function(a){c.connection.send(a)};this.addDevice=function(){};this.removeDevice=function(c){return ODev.devices["delete"](c.id,function(){var b=g.indexOf(c);
0<=b&&g.splice(b,1);a(f.DEVICE_LIST_UPDATE,g)})};this.getDevices=function(){return 0<g.length?g:g=this.sync(!1)};this.getDevicesByType=function(a,c){c||(c=this.getDevices());var b=[];c&&c.forEach(function(c){c.type==a&&b.push(c)});return b};this.getDevicesByBoard=function(a){var c=this.getDevices(),b=[];c&&c.forEach(function(c){c.parentID==a&&c.type!=m.BOARD&&b.push(c)});return b};this.getBoards=function(){return this.getDevicesByType(m.BOARD)};this.getTypes=function(){0==q.length&&ODev.devices.listTypes(function(a){0<
a.length&&a.forEach(function(a){q.push(a)})});return q};this.findDevice=function(a,c){c||(c=g);if(c)for(var b=0;b<c.length;b++){if(c[b].id==a)return c[b]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(b,r){g=d();(r||g&&0==g.length)&&c.send({type:h.GET_DEVICES,forceSync:r});g&&g.forEach(function(a){a.parentID&&(a.parent=c.findDevice(a.parentID,g))});!0===b&&a(f.DEVICE_LIST_UPDATE,g);return g};this.on=function(a,b){return c.addListener(a,b)};this.onDeviceChange=function(a){c.addListener(od.Event.DEVICE_CHANGED,
a)};this.onConnect=function(a){if(c.isConnected()){var b=OpenDevice.getDevices();a&&a(b);return{event:od.Event.CONNECTED}}return this.on(od.Event.CONNECTED,function(){var c=OpenDevice.getDevices();a&&a(c)})};this.removeListener=function(a,c){var b;if(a instanceof Array){c==p&&(p=null);for(var d=0;d<a.length;d++)this.removeListener(a[d])}else"object"==typeof a?(b=a.event,c=a.listener):b=a;null!=l[b]&&(b=l[b],d=b.indexOf(c),0<=d&&b.splice(d,1))};this.addListener=function(a,c){void 0===l[a]&&(l[a]=[]);
l[a].push(c);var b={event:a,listener:c};p&&p.push(b);return b};this.setListenerReceiver=function(a){p=a};this.contains=function(a,b){null==b&&(b=c.getDevices());for(var d=0;d<b.length;d++)if("object"==typeof b[d]){if(a.id==b[d].id)return!0}else if(a.id==b[d])return!0;return!1};this.isConnected=function(){return c.connection.isConnected()&&k};this.notifyDeviceListeners=function(b,d){d&&c.connection.send({type:b.type,deviceID:b.id,value:b.value});for(var e=0;e<b.listeners.length;e++)if("function"==
typeof b.listeners[e])b.listeners[e](b.value,b.id);else b.listeners[e].listener.call(b.listeners[e].context,b.value,b.id);a(f.DEVICE_CHANGED,b)};c.connection.addListener({onMessageReceived:function(b,e){if(!h.isDeviceCommand(e.type)||b.getConnectionUUID()!=e.connectionUUID)if(e.type==h.CONNECT_RESPONSE&&e.status==od.CommandStatus.UNAUTHORIZED)a(f.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED);else if(e.type==h.USER_EVENT)a(e.name,e);else{if(h.isDeviceCommand(e.type)){console.log("Device changed in another client..");
var k=c.findDevice(e.deviceID);k&&k.setValue(e.value,!1)}e.type==h.GET_DEVICES_RESPONSE&&(k=d())&&0<k.length&&a(f.DEVICE_LIST_UPDATE,k)}},connectionStateChanged:function(b,d,e){console.log("DeviceManager._connectionStateChanged :"+d);a(f.CONNECTION_CHANGE,d);od.ConnectionStatus.CONNECTED==d&&a(f.CONNECTED,c.getDevices());od.ConnectionStatus.DISCONNECTED==d&&a(f.DISCONNECTED)}})};od=od||{};od.SESSION_ID="AuthToken";od.version="0.3.2";od.appID="*";od.serverURL=window.location.origin;
var OpenDevice=function(){var e=new od.DeviceConnection({logLevel:"debug"}),a=new od.DeviceManager(e);return{appID:od.appID,serverURL:od.serverURL,manager:a,on:a.on,removeListener:a.removeListener,setListenerReceiver:a.setListenerReceiver,onDeviceChange:a.onDeviceChange,onChange:a.onDeviceChange,onConnect:a.onConnect,isConnected:a.isConnected,findDevice:a.findDevice,get:a.findDevice,removeDevice:a.removeDevice,getDevices:a.getDevices,getDevicesByType:a.getDevicesByType,getDevicesByBoard:a.getDevicesByBoard,
getBoards:a.getBoards,getTypes:a.getTypes,setValue:a.setValue,toggleValue:a.toggleValue,contains:a.contains,sync:a.sync,send:a.send,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){a&&(e=a);e.connect()},rest:function(a,b){var c={type:"GET",url:od.serverURL+a,headers:{Authorization:"Bearer "+od.appID},async:!1};$.extend(c,b||{});var e=$.ajax(c);e.fail(function(){console.error("Rest fail, status ("+e.status+"): "+e.responseText)});return null==c.async||0==c.async?
200==e.status&&0<e.responseText.length?JSON.parse(e.responseText):null:e},history:function(a,b,c){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+od.appID},type:"POST",url:od.serverURL+OpenDevice.devices.path+"/"+a.deviceID+"/history",data:JSON.stringify(a),dataType:"json",async:!0,success:b,error:c})},logout:function(a){return $.get(od.serverURL+"/api/auth/logout",a)},findAppID:function(){od.appID=function(a){var b;b=window.location.search.substr(1).split("\x26");
if(""==b)b={};else{for(var c={},e=0;e<b.length;++e){var f=b[e].split("\x3d",2);c[f[0]]=1==f.length?"":decodeURIComponent(f[1].replace(/\+/g," "))}b=c}return b[a]}(od.SESSION_ID);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.SESSION_ID);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.SESSION_ID));return od.appID}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/api/devices",get:function(e){return OpenDevice.rest(this.path+"/"+e)},value:function(e,a){return null!=a?OpenDevice.rest(this.path+"/"+e+"/value/"+a):OpenDevice.rest(this.path+"/"+e+"/value")},list:function(){return OpenDevice.rest(this.path+"/")},listTypes:function(e,a){return OpenDevice.rest(this.path+"/types",{async:!0,success:e,error:a})},sync:function(){return OpenDevice.rest(this.path+"/sync")},"delete":function(e,a,d){return OpenDevice.rest(this.path+"/"+e,{async:!0,
type:"DELETE",success:a,error:d})}};