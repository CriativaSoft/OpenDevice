var od=od||{};od.DeviceType={ANALOG:1,DIGITAL:2,SENSOR:3};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={ON_OFF:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,DEVICE_COMMAND_RESPONSE:10,PING_REQUEST:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,isDeviceCommand:function(d){switch(d){case this.ON_OFF:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.CommandType;od.DeviceEvent={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_UPDATE:"DEVICE_UPDATE",DEVICE_CHANGED:"DEVICE_UPDATE",CONNECTION_CHANGE:"CONNECTION_CHANGE"};od=od||{};
od.Device=function(d){this.id=d.id;this.name=d.name;this.type=d.type;this.category=d.category;this.value=d.value;this.sensor=d.sensor;this.manager=od.deviceManager;this.setValue=function(b){this.value=b;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=function(){var b=0;0==this.value?b=1:1==this.value&&(b=0);this.setValue(b)}};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(d){function b(a){for(var g=0;g<c.length;g++){var f=c[g].connectionStateChanged;"function"===typeof f&&f(h,a,this.status)}this.status=a}var e=od.ConnectionStatus,l=window.atmosphere||$.atmosphere,k,h=this,c=[];od.connection=this;this.status=e.DISCONNECTED;this.config=d;this.url=d.url;(function(a){a.url+="/device/connection/"+a.applicationID;void 0==a.contentType&&(a.contentType="application/json");void 0==a.transport&&(a.transport="websocket");void 0==a.fallbackTransport&&
(a.fallbackTransport="long-polling");void 0==a.reconnectInterval&&(a.reconnectInterval=5E3);void 0==a.maxReconnectOnClose&&(a.maxReconnectOnClose=5);a.onError=function(g){console.log("Connection.onError");b(e.FAIL)};a.onMessage=function(g){try{var a=JSON.parse(g.responseBody);console.log("Connection.onMessageReceived(from:"+g.request.uuid+") -\x3e "+g.responseBody);for(var m=0;m<c.length;m++){var b=c[m].onMessageReceived;"function"===typeof b&&b(h,a)}}catch(d){console.error(" Can't parse response -\x3e "+
g.responseBody)}};a.onMessagePublished=function(a){console.log("Connection.onMessagePublished")};a.onClose=function(a){console.log("Connection.onClose");b(e.DISCONNECTED)};a.onOpen=function(a){console.log("Connection.onOpen");b(e.CONNECTED)};a.onReopen=function(a){console.log("Connection.onReopen");b(e.CONNECTED)};a.onReconnect=function(a){console.log("Connection.onReconnect");b(e.CONNECTING)};a.onTransportFailure=function(a){console.log("Connection.onTransportFailure");b(e.FAIL)};a.onFailureToReconnect=
function(a){console.log("Connection.onFailureToReconnect");b(e.DISCONNECTED)};a.onClientTimeout=function(a){console.log("Connection.onClientTimeout");b(e.FAIL)}})(d);this.connect=function(){console.log("Connection to: "+d.url);k=l.subscribe(d);b(e.CONNECTING);return h};this.send=function(a){k.push(JSON.stringify(a))};this.addListener=function(a){c.push(a)};this.isConnected=function(){return h.status=e.CONNECTED};this.getConnectionUUID=function(){return k.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(d){function b(a){c=null;var f;f=$.ajax({type:"GET",url:d.url+"/device/list",async:!1}).responseText;f=JSON.parse(f);for(var b=[],h=0;h<f.length;h++)b.push(new od.Device(f[h]));c=b;!0===a&&e(k.DEVICE_LIST_UPDATE,c);return c}function e(g,f){if(void 0!==a[g])for(var b=a[g],c=0;c<b.length;c++)if("function"===typeof b[c])b[c](f)}od.deviceManager=this;var l=this,k=od.DeviceEvent,h=od.CommandType,c=[],a={};this.connection=d||od.connection;this.setValue=function(a,f){this.connection.send({type:h.ON_OFF,
deviceID:a,value:f});var b=this.findDevice(a);b&&(b.value=f,e(k.DEVICE_UPDATE,b))};this.toggleValue=function(a){(a=this.findDevice(a))&&a.toggleValue()};this.addDevice=function(){};this.getDevices=function(){return c&&0<c.length?c:c=b(!1)};this.findDevice=function(a){if(c)for(var b=0;b<c.length;b++){if(c[b].id==a)return c[b]}else console.warn("Devices not loaded or empty !");return null};this.on=function(){this.addListener.apply(this,arguments)};this.addListener=function(b,c){void 0===a[b]&&(a[b]=
[]);a[b].push(c)};l.connection.addListener({onMessageReceived:function(a,b){if((!h.isDeviceCommand(b.type)||a.getConnectionUUID()!=b.connectionUUID)&&h.isDeviceCommand(b.type)){console.log("Device changed in another client..");var c=l.findDevice(b.deviceID);c&&(c.value=b.value);c&&e(k.DEVICE_UPDATE,c)}},connectionStateChanged:function(a,c,d){console.log("DeviceManager._connectionStateChanged :"+c);od.ConnectionStatus.CONNECTED==c&&b(!0)}})};