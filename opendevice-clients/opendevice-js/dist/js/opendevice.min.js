var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2,NUMERIC:3};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};
od.CommandType={DIGITAL:1,ANALOG:2,NUMERIC:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,INFRA_RED:6,DEVICE_COMMAND_RESPONSE:10,COMMAND_RESPONSE:11,SET_PROPERTY:12,ACTION:13,PING_REQUEST:20,PING_RESPONSE:21,DISCOVERY_REQUEST:22,DISCOVERY_RESPONSE:23,MEMORY_REPORT:24,CPU_TEMPERATURE_REPORT:25,CPU_USAGE_REPORT:26,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,DEVICE_ADD:32,DEVICE_ADD_RESPONSE:33,DEVICE_DEL:34,CLEAR_DEVICES:35,GET_CONNECTIONS:36,GET_CONNECTIONS_RESPONSE:37,CONNECTION_ADD:38,CONNECTION_ADD_RESPONSE:39,CONNECTION_DEL:40,
CLEAR_CONNECTIONS:41,CONNECT:42,CONNECT_RESPONSE:43,USER_COMMAND:99,isDeviceCommand:function(h){switch(h){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.NUMERIC:return!0}return!1}};od.CommandStatus={DELIVERED:1,RECEIVED:2,FAIL:3,EMPTY_DATABASE:4,SUCCESS:200,NOT_FOUND:404,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,PERMISSION_DENIED:550,INTERNAL_ERROR:500,NOT_IMPLEMENTED:501};
od.Event={DEVICE_LIST_UPDATE:"devicesUpdate",DEVICE_CHANGED:"deviceChanged",CONNECTION_CHANGE:"connectionCgange",CONNECTED:"connected",DISCONNECTED:"disconnected",LOGIN_FAILURE:"loginFail"};od=od||{};
od.Device=function(h){var d=od.CommandType,a=this;this.type=od.DeviceType.DIGITAL;this.listeners=[];this.on=function(){this.setValue(1,!0)};this.off=function(){this.setValue(0,!0)};this.isON=function(){return 1==this.value};this.isOFF=function(){return 0==this.value};this.setValue=function(a,b){b="undefined"!==typeof b?b:!0;if(this.type==od.DeviceType.NUMERIC||this.value!=a)this.value=a,this.lastUpdate=(new Date).getTime(),this.manager&&this.manager.notifyDeviceListeners(this,b)};this.toggleValue=
this.toggle=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)};this.onChange=function(a){this.listeners.push(a)};this.removeListener=function(a){a=this.listeners.indexOf(a);0<a&&this.listeners.splice(a,1)};(function(c){this.id=c.id;this.manager=od.deviceManager;for(var b in c)this[b]=c[b];for(var h in this.properties)this[h]=this.properties[h];this.actions.forEach(function(b){a[b]=function(){console.log("Calling remote action: "+b+", params: ",arguments);var c=[],e;for(e in arguments)c.push(arguments[e]);
a.manager.send({type:d.ACTION,deviceID:a.id,action:b,params:c})}})}).call(this,h)};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(h){function d(a){for(var f=0;f<g.length;f++){var k=g[f].onMessageReceived;"function"===typeof k&&k(c,a)}}function a(a){for(var f=0;f<g.length;f++){var k=g[f].connectionStateChanged;"function"===typeof k&&k(c,a,c.status)}c.status=a}var c=this,b=od.ConnectionStatus,m=window.atmosphere||$.atmosphere,l,g=[];od.connection=this;this.status=b.DISCONNECTED;this.config=h;(function(e){void 0==e.contentType&&(e.contentType="application/json");void 0==e.transport&&(e.transport="websocket");
void 0==e.fallbackTransport&&(e.fallbackTransport="long-polling");void 0==e.reconnectInterval&&(e.reconnectInterval=5E3);void 0==e.maxReconnectOnClose&&(e.maxReconnectOnClose=5);e.onError=function(f){console.log("Connection.onError");a(b.FAIL)};e.onMessage=function(f){var a=null;if("X"!=f.responseBody)if("Authorization Required"==f.responseBody)console.warn("Authorization Required"),d({type:od.CommandType.CONNECT_RESPONSE,status:od.CommandStatus.UNAUTHORIZED});else{try{a=JSON.parse(f.responseBody)}catch(b){console.error("Can't parse response: \x3c\x3c"+
f.responseBody+"\x3e\x3e"),console.error(b.stack)}a&&(console.log("Connection.onMessageReceived(from:"+f.request.uuid+") -\x3e "+f.responseBody),d(a))}};e.onMessagePublished=function(f){console.log("Connection.onMessagePublished")};e.onClose=function(f){console.log("Connection.onClose");a(b.DISCONNECTED)};e.onOpen=function(f){console.log("Connection.onOpen");a(b.CONNECTED)};e.onReopen=function(f){console.log("Connection.onReopen");a(b.CONNECTED)};e.onReconnect=function(f){console.log("Connection.onReconnect");
a(b.CONNECTING)};e.onTransportFailure=function(f){console.log("Connection.onTransportFailure");a(b.FAIL)};e.onFailureToReconnect=function(f){console.log("Connection.onFailureToReconnect");a(b.DISCONNECTED)};e.onClientTimeout=function(f){console.log("Connection.onClientTimeout");a(b.FAIL)}})(h);this.connect=function(){c.status!=b.CONNECTED?(c.config.url=c.getUrl(),console.log("Connection to: "+c.config.url),l=m.subscribe(c.config),a(b.CONNECTING)):console.log("Already Connected");return c};this.getUrl=
function(){return od.serverURL+"/ws/device/"+od.appID};this.send=function(a){l.push(JSON.stringify(a))};this.addListener=function(a){g.push(a)};this.isConnected=function(){return c.status=b.CONNECTED};this.getConnectionUUID=function(){return l.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(h){function d(f,a){if(void 0!==e[f])for(var b=e[f],c=0;c<b.length;c++)if("function"===typeof b[c])try{b[c](a)}catch(d){console.log(d)}}function a(){for(var f=OpenDevice.devices.list(),a=[],b=0;b<f.length;b++){var d=new od.Device(f[b]);"undefined"!=typeof Object.observe?Object.observe(d,c):console.warn("Object.observe not supported in this browser.");a.push(d)}return a}function c(a){if(0<a.length&&"update"==a[0].type&&"value"!=a[0].name){var k=a[0].object;b.send({type:l.SET_PROPERTY,
deviceID:k.id,property:a[0].name,value:k[a[0].name]})}}var b=this;od.deviceManager=this;var m=od.Event,l=od.CommandType,g=[],e={};this.connection=h||od.connection;this.setValue=function(a,k){var c=b.findDevice(a);c&&c.setValue(k)};this.toggleValue=function(a){(a=b.findDevice(a))&&!a.sensor&&a.toggle()};this.send=function(a){b.connection.send(a)};this.addDevice=function(){};this.getDevices=function(){return g&&0<g.length?g:g=this.sync(!1)};this.findDevice=function(a){if(g)for(var b=0;b<g.length;b++){if(g[b].id==
a)return g[b]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(f,k){g=null;g=a();(k||g&&0==g.length)&&b.send({type:l.GET_DEVICES,forceSync:k});!0===f&&d(m.DEVICE_LIST_UPDATE,g);return g};this.on=function(a,k){b.addListener(a,k)};this.onDeviceChange=function(a){b.addListener(od.Event.DEVICE_CHANGED,a)};this.onConnect=function(a){this.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();a&&a(b)})};this.addListener=function(a,b){void 0===e[a]&&(e[a]=[]);e[a].push(b)};
this.contains=function(a,c){null==c&&(c=b.getDevices());for(var d=0;d<c.length;d++)if("object"==typeof c[d]){if(a.id==c[d].id)return!0}else if(a.id==c[d])return!0;return!1};this.notifyDeviceListeners=function(a,c){c&&b.connection.send({type:a.type,deviceID:a.id,value:a.value});for(var e=0;e<a.listeners.length;e++)a.listeners[e](a.value,a.id);d(m.DEVICE_CHANGED,a)};b.connection.addListener({onMessageReceived:function(c,e){if(!l.isDeviceCommand(e.type)||c.getConnectionUUID()!=e.connectionUUID)if(e.type==
l.CONNECT_RESPONSE&&e.status==od.CommandStatus.UNAUTHORIZED)d(m.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED);else{if(l.isDeviceCommand(e.type)){console.log("Device changed in another client..");var g=b.findDevice(e.deviceID);g&&g.setValue(e.value,!1)}e.type==l.GET_DEVICES_RESPONSE&&(g=a(),d(m.DEVICE_LIST_UPDATE,g))}},connectionStateChanged:function(a,c,e){console.log("DeviceManager._connectionStateChanged :"+c);d(m.CONNECTION_CHANGE,c);od.ConnectionStatus.CONNECTED==c&&d(m.CONNECTED,b.getDevices());
od.ConnectionStatus.CONNECTED==c&&d(m.DISCONNECTED)}})};od=od||{};od.SESSION_ID="AuthToken";od.version="0.3.2";od.appID="*";od.serverURL=window.location.origin;
var OpenDevice=function(){var h=new od.DeviceConnection({logLevel:"debug"}),d=new od.DeviceManager(h);return{appID:od.appID,serverURL:od.serverURL,manager:d,on:d.on,onDeviceChange:d.onDeviceChange,onChange:d.onDeviceChange,onConnect:d.onConnect,findDevice:d.findDevice,get:d.findDevice,getDevices:d.getDevices,setValue:d.setValue,toggleValue:d.toggleValue,contains:d.contains,sync:d.sync,send:d.send,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){a&&(h=a);h.connect()},
rest:function(a){a=$.ajax({type:"GET",url:od.serverURL+a,headers:{Authorization:"Bearer "+od.appID},async:!1});if(200==a.status&&0<a.responseText.length)return JSON.parse(a.responseText);console.error("Rest fail, status ("+a.status+"): "+a.responseText);return null},history:function(a,c){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+od.appID},type:"POST",url:od.serverURL+"/device/"+a.deviceID+"/history",data:JSON.stringify(a),dataType:"json",
async:!0,success:c})},logout:function(a){return $.get(od.serverURL+"/api/auth/logout",a)},findAppID:function(){od.appID=function(a){var c;c=window.location.search.substr(1).split("\x26");if(""==c)c={};else{for(var b={},d=0;d<c.length;++d){var h=c[d].split("\x3d",2);b[h[0]]=1==h.length?"":decodeURIComponent(h[1].replace(/\+/g," "))}c=b}return c[a]}(od.SESSION_ID);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.SESSION_ID);
if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.SESSION_ID));return od.appID}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/device",get:function(h){return OpenDevice.rest(OpenDevice.devices.path+"/"+h)},value:function(h,d){return null!=d?OpenDevice.rest(OpenDevice.devices.path+"/"+h+"/value/"+d):OpenDevice.rest(OpenDevice.devices.path+"/"+h+"/value")},list:function(){return OpenDevice.rest(OpenDevice.devices.path+"/list")},sync:function(){return OpenDevice.rest(OpenDevice.devices.path+"/sync")}};