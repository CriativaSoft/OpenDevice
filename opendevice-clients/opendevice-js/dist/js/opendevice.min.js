var od=od||{};od.DeviceType={ANALOG:1,DIGITAL:2,SENSOR:3};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};od.CommandType={ON_OFF:1,ANALOG:2,ANALOG_REPORT:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,DEVICE_COMMAND_RESPONSE:10,PING_REQUEST:20,PING_RESPONSE:21,MEMORY_REPORT:22,CPU_TEMPERATURE_REPORT:23,CPU_USAGE_REPORT:24,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,isDeviceCommand:function(a){switch(a){case this.ON_OFF:return!0;case this.ANALOG:return!0;case this.ANALOG_REPORT:return!0}return!1}};
od.DeviceEvent={DEVICE_LIST_UPDATE:"DEVICE_LIST_UPDATE",DEVICE_UPDATE:"DEVICE_UPDATE",DEVICE_CHANGED:"DEVICE_UPDATE",CONNECTION_CHANGE:"CONNECTION_CHANGE"};od=od||{};
od.Device=function(a){this.id=a.id;this.name=a.name;this.type=a.type;this.category=a.category;this.value=a.value;this.sensor=a.sensor;this.manager=od.deviceManager;this.setValue=function(a){this.value=a;this.manager&&this.manager.setValue(this.id,this.value)};this.toggleValue=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)}};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(a){function b(a){for(var l=0;l<c.length;l++){var h=c[l].connectionStateChanged;"function"===typeof h&&h(e,a,this.status)}this.status=a}var d=od.ConnectionStatus,g=window.atmosphere||$.atmosphere,f,e=this,c=[];od.connection=this;this.status=d.DISCONNECTED;this.config=a;this.url=od.serverURL+"/device/connection/"+od.appID;(function(a){a.url=e.url;void 0==a.contentType&&(a.contentType="application/json");void 0==a.transport&&(a.transport="websocket");void 0==a.fallbackTransport&&
(a.fallbackTransport="long-polling");void 0==a.reconnectInterval&&(a.reconnectInterval=5E3);void 0==a.maxReconnectOnClose&&(a.maxReconnectOnClose=5);a.onError=function(a){console.log("Connection.onError");b(d.FAIL)};a.onMessage=function(a){try{var h=JSON.parse(a.responseBody);console.log("Connection.onMessageReceived(from:"+a.request.uuid+") -\x3e "+a.responseBody);for(var b=0;b<c.length;b++){var d=c[b].onMessageReceived;"function"===typeof d&&d(e,h)}}catch(f){console.error(" Can't parse response -\x3e "+
a.responseBody)}};a.onMessagePublished=function(a){console.log("Connection.onMessagePublished")};a.onClose=function(a){console.log("Connection.onClose");b(d.DISCONNECTED)};a.onOpen=function(a){console.log("Connection.onOpen");b(d.CONNECTED)};a.onReopen=function(a){console.log("Connection.onReopen");b(d.CONNECTED)};a.onReconnect=function(a){console.log("Connection.onReconnect");b(d.CONNECTING)};a.onTransportFailure=function(a){console.log("Connection.onTransportFailure");b(d.FAIL)};a.onFailureToReconnect=
function(a){console.log("Connection.onFailureToReconnect");b(d.DISCONNECTED)};a.onClientTimeout=function(a){console.log("Connection.onClientTimeout");b(d.FAIL)}})(a);this.connect=function(){console.log("Connection to: "+a.url);f=g.subscribe(a);b(d.CONNECTING);return e};this.send=function(a){f.push(JSON.stringify(a))};this.addListener=function(a){c.push(a)};this.isConnected=function(){return e.status=d.CONNECTED};this.getConnectionUUID=function(){return f.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(a){function b(a){c=null;for(var h=OpenDevice.devices.list(),b=[],e=0;e<h.length;e++)b.push(new od.Device(h[e]));c=b;!0===a&&d(f.DEVICE_LIST_UPDATE,c);return c}function d(a,b){if(void 0!==k[a])for(var d=k[a],c=0;c<d.length;c++)if("function"===typeof d[c])d[c](b)}od.deviceManager=this;var g=this,f=od.DeviceEvent,e=od.CommandType,c=[],k={};this.connection=a||od.connection;this.setValue=function(a,b){this.connection.send({type:e.ON_OFF,deviceID:a,value:b});var c=this.findDevice(a);
c&&(c.value=b,d(f.DEVICE_UPDATE,c))};this.toggleValue=function(a){(a=this.findDevice(a))&&!a.sensor&&a.toggleValue()};this.addDevice=function(){};this.getDevices=function(){return c&&0<c.length?c:c=b(!1)};this.findDevice=function(a){if(c)for(var b=0;b<c.length;b++){if(c[b].id==a)return c[b]}else console.warn("Devices not loaded or empty !");return null};this.on=function(){this.addListener.apply(this,arguments)};this.addListener=function(a,b){void 0===k[a]&&(k[a]=[]);k[a].push(b)};g.connection.addListener({onMessageReceived:function(a,
b){if((!e.isDeviceCommand(b.type)||a.getConnectionUUID()!=b.connectionUUID)&&e.isDeviceCommand(b.type)){console.log("Device changed in another client..");var c=g.findDevice(b.deviceID);c&&(c.value=b.value);c&&d(f.DEVICE_UPDATE,c)}},connectionStateChanged:function(a,c,d){console.log("DeviceManager._connectionStateChanged :"+c);od.ConnectionStatus.CONNECTED==c&&b(!0)}})};od=od||{};od.version="1.0";od.APP_ID_NAME="AppID";od.appID;od.serverURL="http://"+window.location.host;
var OpenDevice=function(){return{appID:od.appID,serverURL:od.serverURL,on:od.deviceManager.on,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},rest:function(a){a=$.ajax({type:"GET",url:od.serverURL+a,headers:{"X-AppID":od.appID},async:!1}).responseText;return JSON.parse(a)},findAppID:function(){od.appID=function(a){var b;b=window.location.search.substr(1).split("\x26");if(""==b)b={};else{for(var d={},g=0;g<b.length;++g){var f=b[g].split("\x3d",2);d[f[0]]=1==f.length?"":decodeURIComponent(f[1].replace(/\+/g,
" "))}b=d}return b[a]}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.APP_ID_NAME);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.APP_ID_NAME));return od.appID}}}();
OpenDevice.devices={path:"/device",get:function(a){return OpenDevice.rest(OpenDevice.devices.path+"/"+a)},value:function(a,b){return null!=b?OpenDevice.rest(OpenDevice.devices.path+"/"+a+"/value/"+b):OpenDevice.rest(OpenDevice.devices.path+"/"+a+"/value")},list:function(a){return OpenDevice.rest(OpenDevice.devices.path+"/list")}};