var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2,ANALOG_SIGNED:3,NUMERIC:4,FLOAT2:5,FLOAT2_SIGNED:6,FLOAT4:7,CHARACTER:8,BOARD:10,MANAGER:11,isAnalog:function(f){return f==od.DeviceType.ANALOG||f==od.DeviceType.FLOAT2||f==od.DeviceType.FLOAT4||f==od.DeviceType.FLOAT2_SIGNED}};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};
od.CommandType={DIGITAL:1,ANALOG:2,NUMERIC:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,INFRA_RED:6,DEVICE_COMMAND_RESPONSE:10,COMMAND_RESPONSE:11,SET_PROPERTY:12,ACTION:13,PING_REQUEST:20,PING_RESPONSE:21,DISCOVERY_REQUEST:22,DISCOVERY_RESPONSE:23,MEMORY_REPORT:24,CPU_TEMPERATURE_REPORT:25,CPU_USAGE_REPORT:26,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,DEVICE_SAVE:32,DEVICE_SAVE_RESPONSE:33,DEVICE_DEL:34,CLEAR_DEVICES:35,SYNC_DEVICES_ID:36,SYNC_HISTORY:37,FIRMWARE_UPDATE:38,GET_CONNECTIONS:40,GET_CONNECTIONS_RESPONSE:41,
CONNECTION_ADD:42,CONNECTION_ADD_RESPONSE:43,CONNECTION_DEL:44,CLEAR_CONNECTIONS:45,CONNECT:46,CONNECT_RESPONSE:47,USER_EVENT:98,USER_COMMAND:99,isDeviceCommand:function(f){switch(f){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.NUMERIC:return!0}return!1}};od.CommandStatus={DELIVERED:1,RECEIVED:2,FAIL:3,EMPTY_DATABASE:4,SUCCESS:200,NOT_FOUND:404,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,PERMISSION_DENIED:550,INTERNAL_ERROR:500,NOT_IMPLEMENTED:501};
od.Event={DEVICE_LIST_UPDATE:"devicesUpdate",DEVICE_CHANGED:"deviceChanged",CONNECTION_CHANGE:"connectionChange",CONNECTED:"connected",DISCONNECTED:"disconnected",LOGIN_FAILURE:"loginFail"};od=od||{};
od.Device=function(f){var c=od.CommandType,d=this;this.type=od.DeviceType.DIGITAL;this.listeners=[];this.updateRawData=function(a){for(var b in a)this[b]=a[b];for(var f in this.properties)this[f]=this.properties[f];this.description||(this.description=this.name);this.actions.forEach(function(b){d[b]=function(){console.log("Calling remote action: "+b+", params: ",arguments);var a=[],p;for(p in arguments)a.push(arguments[p]);d.manager.send({type:c.ACTION,deviceID:d.id,action:b,params:a})}})};this.on=
function(){this.setValue(1,!0)};this.off=function(){this.setValue(0,!0)};this.isON=function(){return 1==this.value};this.isOFF=function(){return 0==this.value};this.setValue=function(a,b){b="undefined"!==typeof b?b:!0;if(this.type==od.DeviceType.NUMERIC||this.value!=a)this.value=a,this.lastUpdate=(new Date).getTime(),this.manager&&this.manager.notifyDeviceListeners(this,b)};this.toggleValue=this.toggle=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)};this.onChange=function(a,
b){a={context:b,listener:a};this.listeners.push(a);return a};this.removeListener=function(a){a=this.listeners.indexOf(a);0<=a&&this.listeners.splice(a,1)};this.applyChanges=function(a){for(var b in a)a.hasOwnProperty(b)&&"function"!=typeof a[b]&&(this[b]=a[b])};(function(a){this.id=a.id;this.manager=od.deviceManager;this.updateRawData(a)}).call(this,f)};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(f){function c(b){for(var c=0;c<l.length;c++){var d=l[c].onMessageReceived;"function"===typeof d&&d(a,b)}}function d(b){if(a.status!=b)for(var c=0;c<l.length;c++){var d=l[c].connectionStateChanged;"function"===typeof d&&d(a,b,a.status)}a.status=b}var a=this,b=od.ConnectionStatus,h=window.atmosphere||$.atmosphere,k,l=[];od.connection=this;this.status=b.DISCONNECTED;this.config=f;(function(a){void 0==a.contentType&&(a.contentType="application/json");void 0==a.transport&&
(a.transport="websocket");void 0==a.fallbackTransport&&(a.fallbackTransport="long-polling");void 0==a.reconnectInterval&&(a.reconnectInterval=5E3);void 0==a.maxReconnectOnClose&&(a.maxReconnectOnClose=5);a.enableProtocol=!1;a.onError=function(a){console.log("Connection.onError");d(b.FAIL)};a.onMessage=function(b){a:{var a=null;if("X"!=b.responseBody){try{a=JSON.parse(b.responseBody)}catch(n){console.error("Can't parse response: \x3c\x3c"+b.responseBody+"\x3e\x3e");console.error(n.stack);break a}!a.status||
401!=a.status&&403!=a.status?a&&(console.log("Connection.onMessageReceived(from:"+b.request.uuid+") -\x3e "+b.responseBody),c(a)):(console.warn("Authorization Required"),c({type:od.CommandType.CONNECT_RESPONSE,status:od.CommandStatus.UNAUTHORIZED}))}}};a.onMessagePublished=function(a){console.log("Connection.onMessagePublished")};a.onClose=function(a){console.log("Connection.onClose");d(b.DISCONNECTED)};a.onOpen=function(a){console.log("Connection.onOpen");d(b.CONNECTED)};a.onReopen=function(a){console.log("Connection.onReopen");
d(b.CONNECTED)};a.onReconnect=function(a){console.log("Connection.onReconnect");d(b.CONNECTING)};a.onTransportFailure=function(a){console.log("Connection.onTransportFailure");d(b.FAIL)};a.onFailureToReconnect=function(a){console.log("Connection.onFailureToReconnect");d(b.DISCONNECTED)};a.onClientTimeout=function(a){console.log("Connection.onClientTimeout");d(b.FAIL)}})(f);this.connect=function(){a.status!=b.CONNECTED?(a.config.url=a.getUrl(),console.log("Connection to: "+a.config.url),k=h.subscribe(a.config),
d(b.CONNECTING)):console.log("Already Connected");return a};this.getUrl=function(){return od.serverURL+"/ws/device/"+od.appID};this.send=function(a){k.push(JSON.stringify(a))};this.addListener=function(a){l.push(a)};this.isConnected=function(){return a.status==b.CONNECTED};this.getConnectionUUID=function(){return k.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(f){function c(e,a){if(void 0!==m[e]){e=m[e];for(var g=0;g<e.length;g++)if("function"===typeof e[g])try{e[g](a)}catch(r){console.log(r)}}}function d(){var e=OpenDevice.devices.list(),g=[];0<e.length&&q.updateDevices(e);for(var b=0;b<e.length;b++){var c=new od.Device(e[b]);"undefined"!=typeof Object.observe?Object.observe(c,a):console.warn("Object.observe not supported in this browser.");g.push(c)}return g}function a(e){if(0<e.length&&"update"==e[0].type&&"value"!=e[0].name){var a=
e[0].object;b.send({type:k.SET_PROPERTY,deviceID:a.id,property:e[0].name,value:a[e[0].name]})}}var b=this;od.deviceManager=this;var h=od.Event,k=od.CommandType,l=od.DeviceType,p=[],q=new od.DeviceStorage,m={},n=[];this.connection=f||od.connection;this.setValue=function(a,g){var e=b.findDevice(a);null==e&&console.warn("can't find deviceID \x3d "+a);e&&e.setValue(g)};this.toggleValue=function(a){var e=b.findDevice(a);null==e&&console.warn("can't find deviceID \x3d "+a);e&&!e.sensor&&e.toggle()};this.send=
function(a){b.connection.send(a)};this.addDevice=function(){};this.removeDevice=function(a){return ODev.devices.delete(a.id,function(){var e=b.getDevices(),d=e.indexOf(a);0<=d&&e.splice(d,1);c(h.DEVICE_LIST_UPDATE,e)})};this.deleteHitory=function(a){return ODev.devices.deleteHistory(a.id)};this.getDevices=function(){var a=q.getDevices();return a&&0<a.length?a:a=this.sync(!1)};this.getDevicesByType=function(a,b){b||(b=this.getDevices());var e=[];b&&b.forEach(function(b){b.type==a&&e.push(b)});return e};
this.getDevicesByBoard=function(a){var b=this.getDevices(),e=[];b&&b.forEach(function(b){b.parentID==a&&b.type!=l.BOARD&&e.push(b)});return e};this.getBoards=function(){return this.getDevicesByType(l.BOARD)};this.getTypes=function(){0==p.length&&ODev.devices.listTypes(function(a){0<a.length&&a.forEach(function(a){p.push(a)})});return p};this.findDevice=function(a,b){b||(b=this.getDevices());if(b)for(var e=0;e<b.length;e++){if(b[e].id==a)return b[e]}else console.warn("Devices not loaded or empty !");
return null};this.sync=function(a,g){var e=d();(g||e&&0==e.length)&&b.send({type:k.GET_DEVICES,forceSync:g});e&&e.forEach(function(a){a.parentID&&(a.parent=b.findDevice(a.parentID,e))});!0===a&&c(h.DEVICE_LIST_UPDATE,e);return e};this.save=function(a,g){ODev.send({type:k.DEVICE_SAVE,device:a});var e=b.findDevice(a.id);null!=e&&(e.applyChanges(a),b.notifyDeviceListeners(e,!1),g&&g.call(e,!0))};this.on=function(a,g){return b.addListener(a,g)};this.onDeviceChange=function(a){b.addListener(od.Event.DEVICE_CHANGED,
a)};this.onConnect=function(a){if(b.isConnected()){var e=OpenDevice.getDevices();a&&a(e);return{event:od.Event.CONNECTED}}return this.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();a&&a(b)})};this.removeListener=function(a,b){var e;if(a instanceof Array){b==n&&(n=null);for(var c=0;c<a.length;c++)this.removeListener(a[c])}else"object"==typeof a?(e=a.event,b=a.listener):e=a;null!=m[e]&&(a=m[e],b=a.indexOf(b),0<=b&&a.splice(b,1))};this.addListener=function(a,b){void 0===m[a]&&(m[a]=[]);
m[a].push(b);a={event:a,listener:b};n&&n.push(a);return a};this.setListenerReceiver=function(a){n=a};this.contains=function(a,c){null==c&&(c=b.getDevices());for(var e=0;e<c.length;e++)if("object"==typeof c[e]){if(a.id==c[e].id)return!0}else if(a.id==c[e])return!0;return!1};this.isConnected=function(){return b.connection.isConnected()};this.notifyDeviceListeners=function(a,d){d&&b.connection.send({type:a.type,deviceID:a.id,value:a.value});for(d=0;d<a.listeners.length;d++)if("function"==typeof a.listeners[d])a.listeners[d](a.value,
a.id);else a.listeners[d].listener.call(a.listeners[d].context,a.value,a.id);c(h.DEVICE_CHANGED,a)};this.notifyListeners=function(a,b){c(a,b)};b.connection.addListener({onMessageReceived:function(a,g){k.isDeviceCommand(g.type)&&a.getConnectionUUID()==g.connectionUUID||(g.type==k.CONNECT_RESPONSE&&g.status==od.CommandStatus.UNAUTHORIZED?c(h.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED):g.type==k.USER_EVENT?c(g.name,g):(k.isDeviceCommand(g.type)&&(a=b.findDevice(g.deviceID))&&a.setValue(g.value,!1),
g.type==k.GET_DEVICES_RESPONSE&&(g=d())&&0<g.length&&c(h.DEVICE_LIST_UPDATE,g)))},connectionStateChanged:function(a,d,f){console.log("DeviceManager._connectionStateChanged :"+d);c(h.CONNECTION_CHANGE,d);od.ConnectionStatus.CONNECTED==d&&c(h.CONNECTED,b.getDevices());od.ConnectionStatus.DISCONNECTED==d&&c(h.DISCONNECTED)}})};od=od||{};
od.DeviceStorage=function(){var f=[];this.getDevices=function(){return f};this.updateDevices=function(c){localStorage.setItem(od.DEVICES_STORAGE_ID,JSON.stringify(c));for(var d=0;d<c.length;d++){var a=c[d],b;a:{for(b=0;b<f.length;b++){var h=f[b];if(h.id==a.id){b=h;break a}}b=void 0}b?b.updateRawData(a):f.push(new od.Device(a))}}};od=od||{};od.SESSION_ID="AuthToken";od.DEVICES_STORAGE_ID="odev_devices";od.version="0.3.2";od.appID="*";od.serverURL=window.location.origin;
var OpenDevice=function(){var f=new od.DeviceConnection({logLevel:"debug"}),c=new od.DeviceManager(f);return{appID:od.appID,serverURL:od.serverURL,manager:c,on:c.on,removeListener:c.removeListener,notifyListeners:c.notifyListeners,setListenerReceiver:c.setListenerReceiver,onDeviceChange:c.onDeviceChange,onChange:c.onDeviceChange,onConnect:c.onConnect,isConnected:c.isConnected,findDevice:c.findDevice,get:c.findDevice,removeDevice:c.removeDevice,deleteHitory:c.deleteHitory,getDevices:c.getDevices,getDevicesByType:c.getDevicesByType,
getDevicesByBoard:c.getDevicesByBoard,getBoards:c.getBoards,getTypes:c.getTypes,setValue:c.setValue,toggleValue:c.toggleValue,contains:c.contains,sync:c.sync,save:c.save,send:c.send,setAppID:function(d){od.appID=d},setApyKey:function(d){od.appID=d},setServer:function(d){od.serverURL=d},connect:function(d){d&&(f=d);"*"==od.appID&&(od.appID=OpenDevice.findAppID(),console.log("Using APP.ID:",od.appID));f.connect()},rest:function(d,a){d={type:"GET",url:od.serverURL+d,headers:{Authorization:"ApiKey "+
od.appID},async:!1};$.extend(d,a||{});var b=$.ajax(d);b.fail(function(){console.error("Rest fail, status ("+b.status+"): "+b.responseText);401==b.status&&c.notifyListeners(od.Event.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED)});return null==d.async||0==d.async?200==b.status&&0<b.responseText.length?JSON.parse(b.responseText):null:b},history:function(d,a,b){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json",Authorization:"Bearer "+od.appID},type:"POST",url:od.serverURL+
OpenDevice.devices.path+"/"+d.deviceID+"/history",data:JSON.stringify(d),dataType:"json",async:!0,success:a,error:b})},logout:function(d){return $.get(od.serverURL+"/api/auth/logout",d)},findAppID:function(){var d=function(a){var b;b=window.location.search.substr(1).split("\x26");if(""==b)b={};else{for(var d={},c=0;c<b.length;++c){var f=b[c].split("\x3d",2);d[f[0]]=1==f.length?"":decodeURIComponent(f[1].replace(/\+/g," "))}b=d}return b[a]}(od.SESSION_ID);if(null!=d)return d;d=function(a){a=("; "+
document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.SESSION_ID);return null!=d||window.localStorage&&(d=window.localStorage.getItem(od.SESSION_ID),null!=d)?d:"*"}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/api/devices",get:function(f){return OpenDevice.rest(this.path+"/"+f)},value:function(f,c){return null!=c?OpenDevice.rest(this.path+"/"+f+"/value/"+c):OpenDevice.rest(this.path+"/"+f+"/value")},list:function(){return OpenDevice.rest(this.path+"/")},listTypes:function(f,c){return OpenDevice.rest(this.path+"/types",{async:!0,success:f,error:c})},sync:function(){return OpenDevice.rest(this.path+"/sync")},delete:function(f,c,d){return OpenDevice.rest(this.path+"/"+f,{async:!0,
type:"DELETE",success:c,error:d})},deleteHistory:function(f,c,d){return OpenDevice.rest(this.path+"/"+f+"/history",{async:!0,type:"DELETE",success:c,error:d})}};