var od=od||{};od.DeviceType={DIGITAL:1,ANALOG:2,NUMERIC:3,CHARACTER:4,BOARD:10,MANAGER:11};od.DeviceCategory={LAMP:1,FAN:2,GENERIC:3,POWER_SOURCE:4,GENERIC_SENSOR:50,IR_SENSOR:51};
od.CommandType={DIGITAL:1,ANALOG:2,NUMERIC:3,GPIO_DIGITAL:4,GPIO_ANALOG:5,INFRA_RED:6,DEVICE_COMMAND_RESPONSE:10,COMMAND_RESPONSE:11,SET_PROPERTY:12,ACTION:13,PING_REQUEST:20,PING_RESPONSE:21,DISCOVERY_REQUEST:22,DISCOVERY_RESPONSE:23,MEMORY_REPORT:24,CPU_TEMPERATURE_REPORT:25,CPU_USAGE_REPORT:26,GET_DEVICES:30,GET_DEVICES_RESPONSE:31,DEVICE_ADD:32,DEVICE_ADD_RESPONSE:33,DEVICE_DEL:34,CLEAR_DEVICES:35,GET_CONNECTIONS:36,GET_CONNECTIONS_RESPONSE:37,CONNECTION_ADD:38,CONNECTION_ADD_RESPONSE:39,CONNECTION_DEL:40,
CLEAR_CONNECTIONS:41,CONNECT:42,CONNECT_RESPONSE:43,USER_COMMAND:99,isDeviceCommand:function(f){switch(f){case this.DIGITAL:return!0;case this.ANALOG:return!0;case this.NUMERIC:return!0}return!1}};od.CommandStatus={DELIVERED:1,RECEIVED:2,FAIL:3,EMPTY_DATABASE:4,SUCCESS:200,NOT_FOUND:404,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,PERMISSION_DENIED:550,INTERNAL_ERROR:500,NOT_IMPLEMENTED:501};
od.Event={DEVICE_LIST_UPDATE:"devicesUpdate",DEVICE_CHANGED:"deviceChanged",CONNECTION_CHANGE:"connectionCgange",CONNECTED:"connected",DISCONNECTED:"disconnected",LOGIN_FAILURE:"loginFail"};od=od||{};
od.Device=function(f){var d=od.CommandType,a=this;this.type=od.DeviceType.DIGITAL;this.listeners=[];this.on=function(){this.setValue(1,!0)};this.off=function(){this.setValue(0,!0)};this.isON=function(){return 1==this.value};this.isOFF=function(){return 0==this.value};this.setValue=function(a,b){b="undefined"!==typeof b?b:!0;if(this.type==od.DeviceType.NUMERIC||this.value!=a)this.value=a,this.lastUpdate=(new Date).getTime(),this.manager&&this.manager.notifyDeviceListeners(this,b)};this.toggleValue=
this.toggle=function(){var a=0;0==this.value?a=1:1==this.value&&(a=0);this.setValue(a)};this.onChange=function(a,b){var d={context:b,listener:a};this.listeners.push(d);return d};this.removeListener=function(a){a=this.listeners.indexOf(a);0<=a&&this.listeners.splice(a,1)};(function(e){this.id=e.id;this.manager=od.deviceManager;for(var b in e)this[b]=e[b];for(var f in this.properties)this[f]=this.properties[f];this.actions.forEach(function(b){a[b]=function(){console.log("Calling remote action: "+b+
", params: ",arguments);var e=[],c;for(c in arguments)e.push(arguments[c]);a.manager.send({type:d.ACTION,deviceID:a.id,action:b,params:e})}})}).call(this,f)};od=od||{};od.connection={};od.ConnectionStatus={CONNECTING:1,CONNECTED:2,DISCONNECTING:3,DISCONNECTED:4,FAIL:6};
od.DeviceConnection=function(f){function d(a){for(var b=0;b<l.length;b++){var g=l[b].onMessageReceived;"function"===typeof g&&g(e,a)}}function a(a){for(var b=0;b<l.length;b++){var g=l[b].connectionStateChanged;"function"===typeof g&&g(e,a,e.status)}e.status=a}var e=this,b=od.ConnectionStatus,k=window.atmosphere||$.atmosphere,h,l=[];od.connection=this;this.status=b.DISCONNECTED;this.config=f;(function(c){void 0==c.contentType&&(c.contentType="application/json");void 0==c.transport&&(c.transport="websocket");
void 0==c.fallbackTransport&&(c.fallbackTransport="long-polling");void 0==c.reconnectInterval&&(c.reconnectInterval=5E3);void 0==c.maxReconnectOnClose&&(c.maxReconnectOnClose=5);c.onError=function(c){console.log("Connection.onError");a(b.FAIL)};c.onMessage=function(a){a:{var g=null;if("X"!=a.responseBody){try{g=JSON.parse(a.responseBody)}catch(n){console.error("Can't parse response: \x3c\x3c"+a.responseBody+"\x3e\x3e");console.error(n.stack);break a}!g.status||401!=g.status&&403!=g.status?g&&(console.log("Connection.onMessageReceived(from:"+
a.request.uuid+") -\x3e "+a.responseBody),d(g)):(console.warn("Authorization Required"),d({type:od.CommandType.CONNECT_RESPONSE,status:od.CommandStatus.UNAUTHORIZED}))}}};c.onMessagePublished=function(a){console.log("Connection.onMessagePublished")};c.onClose=function(c){console.log("Connection.onClose");a(b.DISCONNECTED)};c.onOpen=function(c){console.log("Connection.onOpen");a(b.CONNECTED)};c.onReopen=function(c){console.log("Connection.onReopen");a(b.CONNECTED)};c.onReconnect=function(c){console.log("Connection.onReconnect");
a(b.CONNECTING)};c.onTransportFailure=function(c){console.log("Connection.onTransportFailure");a(b.FAIL)};c.onFailureToReconnect=function(c){console.log("Connection.onFailureToReconnect");a(b.DISCONNECTED)};c.onClientTimeout=function(c){console.log("Connection.onClientTimeout");a(b.FAIL)}})(f);this.connect=function(){e.status!=b.CONNECTED?(e.config.url=e.getUrl(),console.log("Connection to: "+e.config.url),h=k.subscribe(e.config),a(b.CONNECTING)):console.log("Already Connected");return e};this.getUrl=
function(){return od.serverURL+"/ws/device/"+od.appID};this.send=function(a){h.push(JSON.stringify(a))};this.addListener=function(a){l.push(a)};this.isConnected=function(){return e.status=b.CONNECTED};this.getConnectionUUID=function(){return h.getUUID()}};od=od||{};od.deviceManager={};
od.DeviceManager=function(f){function d(g,a){if(void 0!==m[g])for(var b=m[g],c=0;c<b.length;c++)if("function"===typeof b[c])try{b[c](a)}catch(d){console.log(d)}}function a(){for(var g=OpenDevice.devices.list(),a=[],b=0;b<g.length;b++){var c=new od.Device(g[b]);"undefined"!=typeof Object.observe?Object.observe(c,e):console.warn("Object.observe not supported in this browser.");a.push(c)}return a}function e(g){if(0<g.length&&"update"==g[0].type&&"value"!=g[0].name){var a=g[0].object;b.send({type:h.SET_PROPERTY,
deviceID:a.id,property:g[0].name,value:a[g[0].name]})}}var b=this;od.deviceManager=this;var k=od.Event,h=od.CommandType,l=od.DeviceType,c=[],m={};this.connection=f||od.connection;this.setValue=function(g,a){var c=b.findDevice(g);c&&c.setValue(a)};this.toggleValue=function(a){(a=b.findDevice(a))&&!a.sensor&&a.toggle()};this.send=function(a){b.connection.send(a)};this.addDevice=function(){};this.getDevices=function(){return c&&0<c.length?c:c=this.sync(!1)};this.getDevicesByType=function(a){var b=this.getDevices(),
c=[];b&&b.forEach(function(b){b.type==a&&c.push(b)});return c};this.getDevicesByBoard=function(a){var b=this.getDevices(),c=[];b&&b.forEach(function(b){b.parentID==a&&b.type!=l.BOARD&&c.push(b)});return c};this.getBoards=function(){return this.getDevicesByType(l.BOARD)};this.findDevice=function(a,b){b||(b=c);if(b)for(var d=0;d<b.length;d++){if(b[d].id==a)return b[d]}else console.warn("Devices not loaded or empty !");return null};this.sync=function(g,n){c=null;c=a();(n||c&&0==c.length)&&b.send({type:h.GET_DEVICES,
forceSync:n});!0===g&&d(k.DEVICE_LIST_UPDATE,c);return c};this.on=function(a,c){return b.addListener(a,c)};this.onDeviceChange=function(a){b.addListener(od.Event.DEVICE_CHANGED,a)};this.onConnect=function(a){this.on(od.Event.CONNECTED,function(){var b=OpenDevice.getDevices();a&&a(b)})};this.removeListener=function(a,b){var c;if(a instanceof Array)for(var d=0;d<a.length;d++)this.removeListener(a[d]);else"object"==typeof a?(c=a.event,b=a.listener):c=a;null!=m[c]&&(c=m[c],d=c.indexOf(b),0<=d&&c.splice(d,
1))};this.addListener=function(a,b){void 0===m[a]&&(m[a]=[]);m[a].push(b);return{event:a,listener:b}};this.contains=function(a,c){null==c&&(c=b.getDevices());for(var d=0;d<c.length;d++)if("object"==typeof c[d]){if(a.id==c[d].id)return!0}else if(a.id==c[d])return!0;return!1};this.notifyDeviceListeners=function(a,c){c&&b.connection.send({type:a.type,deviceID:a.id,value:a.value});for(var e=0;e<a.listeners.length;e++)if("function"==typeof a.listeners[e])a.listeners[e](a.value,a.id);else a.listeners[e].listener.call(a.listeners[e].context,
a.value,a.id);d(k.DEVICE_CHANGED,a)};b.connection.addListener({onMessageReceived:function(c,e){if(!h.isDeviceCommand(e.type)||c.getConnectionUUID()!=e.connectionUUID)if(e.type==h.CONNECT_RESPONSE&&e.status==od.CommandStatus.UNAUTHORIZED)d(k.LOGIN_FAILURE,od.CommandStatus.UNAUTHORIZED);else{if(h.isDeviceCommand(e.type)){console.log("Device changed in another client..");var f=b.findDevice(e.deviceID);f&&f.setValue(e.value,!1)}e.type==h.GET_DEVICES_RESPONSE&&(f=a(),d(k.DEVICE_LIST_UPDATE,f))}},connectionStateChanged:function(a,
c,e){console.log("DeviceManager._connectionStateChanged :"+c);d(k.CONNECTION_CHANGE,c);od.ConnectionStatus.CONNECTED==c&&d(k.CONNECTED,b.getDevices());od.ConnectionStatus.CONNECTED==c&&d(k.DISCONNECTED)}})};od=od||{};od.SESSION_ID="AuthToken";od.version="0.3.2";od.appID="*";od.serverURL=window.location.origin;
var OpenDevice=function(){var f=new od.DeviceConnection({logLevel:"debug"}),d=new od.DeviceManager(f);return{appID:od.appID,serverURL:od.serverURL,manager:d,on:d.on,removeListener:d.removeListener,onDeviceChange:d.onDeviceChange,onChange:d.onDeviceChange,onConnect:d.onConnect,findDevice:d.findDevice,get:d.findDevice,getDevices:d.getDevices,getDevicesByType:d.getDevicesByType,getDevicesByBoard:d.getDevicesByBoard,getBoards:d.getBoards,setValue:d.setValue,toggleValue:d.toggleValue,contains:d.contains,
sync:d.sync,send:d.send,setAppID:function(a){od.appID=a},setServer:function(a){od.serverURL=a},connect:function(a){a&&(f=a);f.connect()},rest:function(a){a=$.ajax({type:"GET",url:od.serverURL+a,headers:{Authorization:"Bearer "+od.appID},async:!1});if(200==a.status&&0<a.responseText.length)return JSON.parse(a.responseText);console.error("Rest fail, status ("+a.status+"): "+a.responseText);return null},history:function(a,d,b){jQuery.ajax({headers:{Accept:"application/json","Content-Type":"application/json",
Authorization:"Bearer "+od.appID},type:"POST",url:od.serverURL+OpenDevice.devices.path+"/"+a.deviceID+"/history",data:JSON.stringify(a),dataType:"json",async:!0,success:d,error:b})},logout:function(a){return $.get(od.serverURL+"/api/auth/logout",a)},findAppID:function(){od.appID=function(a){var d;d=window.location.search.substr(1).split("\x26");if(""==d)d={};else{for(var b={},f=0;f<d.length;++f){var h=d[f].split("\x3d",2);b[h[0]]=1==h.length?"":decodeURIComponent(h[1].replace(/\+/g," "))}d=b}return d[a]}(od.SESSION_ID);
if(null!=od.appID)return od.appID;od.appID=function(a){a=("; "+document.cookie).split("; "+a+"\x3d");if(2==a.length)return a.pop().split(";").shift()}(od.SESSION_ID);if(null!=od.appID)return od.appID;window.localStorage&&(od.appID=window.localStorage.getItem(od.SESSION_ID));return od.appID}}}(),ODev=OpenDevice;
OpenDevice.devices={path:"/api/devices",get:function(f){return OpenDevice.rest(this.path+"/"+f)},value:function(f,d){return null!=d?OpenDevice.rest(this.path+"/"+f+"/value/"+d):OpenDevice.rest(this.path+"/"+f+"/value")},list:function(){return OpenDevice.rest(this.path+"/")},sync:function(){return OpenDevice.rest(this.path+"/sync")}};